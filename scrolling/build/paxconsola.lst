 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 1 - 01/22/2022 23:17:32


       1/       0 :                     	    cpu	8048
       2/       0 :                             
       3/       0 :                             include	"g7000.h"
(1)    1/       0 :                     ; This file contains definitions I use in my programs.
(1)    2/       0 :                     
(1)    3/       0 :                     ; $Id: g7000.h 594 2006-12-08 13:59:35Z sgust $
(1)    4/       0 :                     
(1)    5/       0 :                     ; Version 1.3
(1)    6/       0 :                     
(1)    7/       0 :                     ; Copyright (C) 1997-2006 by Soeren Gust, sgust@ithh.informationstheater.de
(1)    8/       0 :                     
(1)    9/       0 :                     ; Permission is hereby granted, free of charge, to any person obtaining a copy
(1)   10/       0 :                     ; of this software and associated documentation files (the "Software"), to deal
(1)   11/       0 :                     ; in the Software without restriction, including without limitation the rights
(1)   12/       0 :                     ; to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
(1)   13/       0 :                     ; copies of the Software, and to permit persons to whom the Software is
(1)   14/       0 :                     ; furnished to do so, subject to the following conditions:
(1)   15/       0 :                     
(1)   16/       0 :                     ; The above copyright notice and this permission notice shall be included in
(1)   17/       0 :                     ; all copies or substantial portions of the Software.
(1)   18/       0 :                     
(1)   19/       0 :                     ; THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
(1)   20/       0 :                     ; IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
(1)   21/       0 :                     ; FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
(1)   22/       0 :                     ; AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
(1)   23/       0 :                     ; LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
(1)   24/       0 :                     ; OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
(1)   25/       0 :                     ; THE SOFTWARE.
(1)   26/       0 :                     
(1)   27/       0 :                     ; NOTE: Since version 0.8.8 I have changed the license conditions. The former
(1)   28/       0 :                     ; GNU Public License did not really make sense since this is just an include
(1)   29/       0 :                     ; file and does not generate code on its own.
(1)   30/       0 :                     
(1)   31/       0 :                     ; You can always get the latest version at http://soeren.informationstheater.de
(1)   32/       0 :                     
(1)   33/       0 :                     ; BIOS routines for Videopac G7000
(1)   34/       0 : =9H                  irq		equ	0009h
(1)   35/       0 : =14H                 irqend		equ	0014h
(1)   36/       0 : =1AH                 vsyncirq	equ	001Ah
(1)   37/       0 : =44H                 soundirq	equ	0044h
(1)   38/       0 : =4BH                 parsesnd	equ	004Bh
(1)   39/       0 : =89H                 copyregs	equ	0089h	; internal
(1)   40/       0 : =0B0H                readkey		equ	00B0h
(1)   41/       0 : =0BCH                readkey_plus	equ	00BCh	; entry point for readkey on VP+ G7400
(1)   42/       0 : =0E7H                vdcenable	equ	00E7h
(1)   43/       0 : =0ECH                extramenable	equ	00ECh
(1)   44/       0 : =0F1H                init		equ	00F1h
(1)   45/       0 : =11CH                gfxoff		equ	011Ch
(1)   46/       0 : =127H                gfxon		equ	0127h
(1)   47/       0 : =132H                tableend	equ	0132h
(1)   48/       0 : =13DH                waitforkey	equ	013Dh
(1)   49/       0 : =14BH                calcchar23	equ	014Bh
(1)   50/       0 : =16BH                clearchar	equ	016Bh
(1)   51/       0 : =176H                waitvsync	equ	0176h
(1)   52/       0 : =17CH                tablebcdbyte	equ	017Ch
(1)   53/       0 : =197H                tableprintchar	equ	0197h
(1)   54/       0 : =1A2H                playsound	equ	01A2h
(1)   55/       0 : =1B0H                doclock		equ	01B0h
(1)   56/       0 : =22CH                tablechar23	equ	022Ch
(1)   57/       0 : =229H                tablebcdnibble	equ	0229h
 AS V1.42 Beta [Bld 213] - Source File main.asm(g7000.h) - Page 2 - 01/22/2022 23:17:32


(1)   58/       0 : =235H                tableput2	equ	0235h
(1)   59/       0 : =23AH                initclock	equ	023Ah
(1)   60/       0 : =261H                putchar23	equ	0261h
(1)   61/       0 : =26AH                bittest		equ	026Ah	; not available on Videopac+ G7400
(1)   62/       0 : =280H                bitclear	equ	0280h	; not available on Videopac+ G7400
(1)   63/       0 : =28AH                bitset		equ	028Ah	; not available on Videopac+ G7400
(1)   64/       0 : =293H                random		equ	0293h	; not available on Videopac+ G7400
(1)   65/       0 : =2A4H                nibblemixer	equ	02A4h	; not available on Videopac+ G7400
(1)   66/       0 : =2C3H                selectgame	equ	02C3h
(1)   67/       0 : =37FH                bank02		equ	037Fh
(1)   68/       0 : =383H                bank01		equ	0383h
(1)   69/       0 : =387H                bank0		equ	0387h
(1)   70/       0 : =38BH                bank3		equ	038Bh
(1)   71/       0 : =38FH                getjoystick	equ	038Fh
(1)   72/       0 : =395H                getjoystick_p17	equ	0395h	; entry point for getjoystick when using P17
(1)   73/       0 : =3B1H                decodejoystick	equ	03B1h
(1)   74/       0 : =3DDH                divide		equ	03DDh
(1)   75/       0 : =3CFH                multiply	equ	03CFh
(1)   76/       0 : =3EAH                printchar	equ	03EAh
(1)   77/       0 :                     
(1)   78/       0 :                     ; the vdc registers
(1)   79/       0 : =0H                  vdc_spr0_ctrl	equ	000h
(1)   80/       0 : =4H                  vdc_spr1_ctrl	equ	004h
(1)   81/       0 : =8H                  vdc_spr2_ctrl	equ	008h
(1)   82/       0 : =0CH                 vdc_spr3_ctrl	equ	00Ch
(1)   83/       0 :                     
(1)   84/       0 : =10H                 vdc_char0	equ	010h
(1)   85/       0 : =14H                 vdc_char1	equ	014h
(1)   86/       0 : =18H                 vdc_char2	equ	018h
(1)   87/       0 : =1CH                 vdc_char3	equ	01Ch
(1)   88/       0 : =20H                 vdc_char4	equ	020h
(1)   89/       0 : =24H                 vdc_char5	equ	024h
(1)   90/       0 : =28H                 vdc_char6	equ	028h
(1)   91/       0 : =2CH                 vdc_char7	equ	02Ch
(1)   92/       0 : =30H                 vdc_char8	equ	030h
(1)   93/       0 : =34H                 vdc_char9	equ	034h
(1)   94/       0 : =38H                 vdc_chara	equ	038h
(1)   95/       0 : =3CH                 vdc_charb	equ	03Ch
(1)   96/       0 :                     
(1)   97/       0 : =40H                 vdc_quad0	equ	040h
(1)   98/       0 : =50H                 vdc_quad1	equ	050h
(1)   99/       0 : =60H                 vdc_quad2	equ	060h
(1)  100/       0 : =70H                 vdc_quad3	equ	070h
(1)  101/       0 :                     
(1)  102/       0 : =80H                 vdc_spr0_shape	equ	080h
(1)  103/       0 : =88H                 vdc_spr1_shape	equ	088h
(1)  104/       0 : =90H                 vdc_spr2_shape	equ	090h
(1)  105/       0 : =98H                 vdc_spr3_shape	equ	098h
(1)  106/       0 :                     
(1)  107/       0 : =0A0H                vdc_control	equ	0a0h
(1)  108/       0 : =0A1H                vdc_status	equ	0a1h
(1)  109/       0 : =0A2H                vdc_collision	equ	0a2h
(1)  110/       0 : =0A3H                vdc_color	equ	0a3h
(1)  111/       0 : =0A4H                vdc_scanline	equ	0a4h
(1)  112/       0 : =0A5H                vdc_scanrow	equ	0a5h
(1)  113/       0 :                     ;vdc_unknown	equ	0a6h
(1)  114/       0 : =0A7H                vdc_sound0	equ	0a7h
(1)  115/       0 : =0A8H                vdc_sound1	equ	0a8h
(1)  116/       0 : =0A9H                vdc_sound2	equ	0a9h
(1)  117/       0 : =0AAH                vdc_soundctrl	equ	0aah
 AS V1.42 Beta [Bld 213] - Source File main.asm(g7000.h) - Page 3 - 01/22/2022 23:17:32


(1)  118/       0 :                     
(1)  119/       0 : =0C0H                vdc_gridh0	equ	0C0h
(1)  120/       0 : =0C1H                vdc_gridh1	equ	0C1h
(1)  121/       0 : =0C2H                vdc_gridh2	equ	0C2h
(1)  122/       0 : =0C3H                vdc_gridh3	equ	0C3h
(1)  123/       0 : =0C4H                vdc_gridh4	equ	0C4h
(1)  124/       0 : =0C5H                vdc_gridh5	equ	0C5h
(1)  125/       0 : =0C6H                vdc_gridh6	equ	0C6h
(1)  126/       0 : =0C7H                vdc_gridh7	equ	0C7h
(1)  127/       0 : =0C8H                vdc_gridh8	equ	0C8h
(1)  128/       0 :                     
(1)  129/       0 : =0D0H                vdc_gridi0	equ	0D0h
(1)  130/       0 : =0D1H                vdc_gridi1	equ	0D1h
(1)  131/       0 : =0D2H                vdc_gridi2	equ	0D2h
(1)  132/       0 : =0D3H                vdc_gridi3	equ	0D3h
(1)  133/       0 : =0D4H                vdc_gridi4	equ	0D4h
(1)  134/       0 : =0D5H                vdc_gridi5	equ	0D5h
(1)  135/       0 : =0D6H                vdc_gridi6	equ	0D6h
(1)  136/       0 : =0D7H                vdc_gridi7	equ	0D7h
(1)  137/       0 : =0D8H                vdc_gridi8	equ	0D8h
(1)  138/       0 :                     
(1)  139/       0 : =0E0H                vdc_gridv0	equ	0E0h
(1)  140/       0 : =0E1H                vdc_gridv1	equ	0E1h
(1)  141/       0 : =0E2H                vdc_gridv2	equ	0E2h
(1)  142/       0 : =0E3H                vdc_gridv3	equ	0E3h
(1)  143/       0 : =0E4H                vdc_gridv4	equ	0E4h
(1)  144/       0 : =0E5H                vdc_gridv5	equ	0E5h
(1)  145/       0 : =0E6H                vdc_gridv6	equ	0E6h
(1)  146/       0 : =0E7H                vdc_gridv7	equ	0E7h
(1)  147/       0 : =0E8H                vdc_gridv8	equ	0E8h
(1)  148/       0 : =0E9H                vdc_gridv9	equ	0E9h
(1)  149/       0 :                     
(1)  150/       0 :                     ; the bits in the vdc_control
(1)  151/       0 : =1H                  vdc_ctrl_hint	equ	001h
(1)  152/       0 : =2H                  vdc_ctrl_beam	equ	002h
(1)  153/       0 : =4H                  vdc_ctrl_sint	equ	004h
(1)  154/       0 : =8H                  vdc_ctrl_grid	equ	008h
(1)  155/       0 : =10H                 vdc_ctrl_ovrlay	equ	010h
(1)  156/       0 : =20H                 vdc_ctrl_fore	equ	020h
(1)  157/       0 : =40H                 vdc_ctrl_dot	equ	040h
(1)  158/       0 : =80H                 vdc_ctrl_fill	equ	080h
(1)  159/       0 :                     
(1)  160/       0 :                     ; the bits in vdc_status
(1)  161/       0 : =1H                  vdc_stat_hblank	equ	001h
(1)  162/       0 : =2H                  vdc_stat_pstrb	equ	002h
(1)  163/       0 : =4H                  vdc_stat_sound	equ	004h
(1)  164/       0 : =8H                  vdc_stat_vblank	equ	008h
(1)  165/       0 : =10H                 vdc_stat_bit4	equ	010h
(1)  166/       0 : =20H                 vdc_stat_bit5	equ	020h
(1)  167/       0 : =40H                 vdc_stat_ovrlay	equ	040h	; unused in G7000/O^2
(1)  168/       0 : =80H                 vdc_stat_chrlap	equ	080h
(1)  169/       0 :                     
(1)  170/       0 :                     ; the bits in vdc_collision
(1)  171/       0 : =1H                  vdc_coll_spr0	equ	001h
(1)  172/       0 : =2H                  vdc_coll_spr1	equ	002h
(1)  173/       0 : =4H                  vdc_coll_spr2	equ	004h
(1)  174/       0 : =8H                  vdc_coll_spr3	equ	008h
(1)  175/       0 : =10H                 vdc_coll_vgrd	equ	010h
(1)  176/       0 : =20H                 vdc_coll_hgrd	equ	020h
(1)  177/       0 : =40H                 vdc_coll_ext	equ	040h	; only used on Videopac+ G7400
 AS V1.42 Beta [Bld 213] - Source File main.asm(g7000.h) - Page 4 - 01/22/2022 23:17:32


(1)  178/       0 : =80H                 vdc_coll_char	equ	080h
(1)  179/       0 :                     
(1)  180/       0 :                     ; the bits in vdc_soundctrl
(1)  181/       0 : =10H                 vdc_sound_noise	equ	010h
(1)  182/       0 : =20H                 vdc_sound_freq	equ	020h
(1)  183/       0 : =40H                 vdc_sound_loop	equ	040h
(1)  184/       0 : =80H                 vdc_sound_enab	equ	080h
(1)  185/       0 :                     
(1)  186/       0 :                     ; the names match the colors on my PAL Videopac G7000
(1)  187/       0 :                     
(1)  188/       0 :                     ; the colors for characters
(1)  189/       0 : =0H                  col_chr_black	equ	00h << 1
(1)  190/       0 : =2H                  col_chr_red	equ	01h << 1
(1)  191/       0 : =4H                  col_chr_green	equ	02h << 1
(1)  192/       0 : =6H                  col_chr_yellow	equ	03h << 1
(1)  193/       0 : =8H                  col_chr_blue	equ	04h << 1
(1)  194/       0 : =0AH                 col_chr_violet	equ	05h << 1
(1)  195/       0 : =0CH                 col_chr_cyan	equ	06h << 1
(1)  196/       0 : =0EH                 col_chr_white	equ	07h << 1
(1)  197/       0 :                     
(1)  198/       0 :                     ; sprite control byte 3
(1)  199/       0 : =2H                  spr_evenshift	equ	02h
(1)  200/       0 : =4H                  spr_double	equ	04h
(1)  201/       0 :                     ; colors for sprites
(1)  202/       0 : =0H                  col_spr_black	equ	00h << 3
(1)  203/       0 : =8H                  col_spr_red	equ	01h << 3
(1)  204/       0 : =10H                 col_spr_green	equ	02h << 3
(1)  205/       0 : =18H                 col_spr_yellow	equ	03h << 3
(1)  206/       0 : =20H                 col_spr_blue	equ	04h << 3
(1)  207/       0 : =28H                 col_spr_violet	equ	05h << 3
(1)  208/       0 : =30H                 col_spr_cyan	equ	06h << 3
(1)  209/       0 : =38H                 col_spr_white	equ	07h << 3
(1)  210/       0 :                     
(1)  211/       0 :                     ; the colors for the grid
(1)  212/       0 : =0H                  col_grd_black	equ	00h
(1)  213/       0 : =1H                  col_grd_blue	equ	01h
(1)  214/       0 : =2H                  col_grd_green	equ	02h
(1)  215/       0 : =3H                  col_grd_cyan	equ	03h
(1)  216/       0 : =4H                  col_grd_red	equ	04h
(1)  217/       0 : =5H                  col_grd_violet	equ	05h
(1)  218/       0 : =6H                  col_grd_yellow	equ	06h
(1)  219/       0 : =7H                  col_grd_white	equ	07h
(1)  220/       0 :                     
(1)  221/       0 :                     ; colors for the grid
(1)  222/       0 : =0H                  col_bck_black	equ	00h << 3
(1)  223/       0 : =8H                  col_bck_blue	equ	01h << 3
(1)  224/       0 : =10H                 col_bck_green	equ	02h << 3
(1)  225/       0 : =18H                 col_bck_cyan	equ	03h << 3
(1)  226/       0 : =20H                 col_bck_red	equ	04h << 3
(1)  227/       0 : =28H                 col_bck_violet	equ	05h << 3
(1)  228/       0 : =30H                 col_bck_yellow	equ	06h << 3
(1)  229/       0 : =38H                 col_bck_white	equ	07h << 3
(1)  230/       0 :                     ; use this to make the grid brighter
(1)  231/       0 : =40H                 col_grd_lum	equ	040h
(1)  232/       0 :                     
(1)  233/       0 :                     ; the locations in internal ram
(1)  234/       0 : =3DH                 iram_collision	equ	03Dh
(1)  235/       0 : =3EH                 iram_clock	equ	03Eh
(1)  236/       0 : =3FH                 iram_irqctrl	equ	03Fh
(1)  237/       0 :                     
 AS V1.42 Beta [Bld 213] - Source File main.asm(g7000.h) - Page 5 - 01/22/2022 23:17:32


(1)  238/       0 :                     ; some bits in the iram
(1)  239/       0 :                     ; iram_clock
(1)  240/       0 : =80H                 clock_stop	equ	080h
(1)  241/       0 : =40H                 clock_forward	equ	040h
(1)  242/       0 :                     ; iram_irqctrl
(1)  243/       0 : =80H                 irq_table	equ	080h
(1)  244/       0 : =40H                 irq_sound	equ	040h
(1)  245/       0 :                     
(1)  246/       0 :                     ; the locations in external ram
(1)  247/       0 : =1H                  eram_minutes	equ	001h
(1)  248/       0 : =2H                  eram_seconds	equ	002h
(1)  249/       0 :                     
(1)  250/       0 :                     ; the builtin tunes
(1)  251/       0 : =28H                 tune_beep_error	equ	028h
(1)  252/       0 : =2EH                 tune_explode	equ	02Eh
(1)  253/       0 : =3CH                 tune_alarm	equ	03Ch
(1)  254/       0 : =4AH                 tune_select	equ	04Ah
(1)  255/       0 : =56H                 tune_keyclick	equ	056h
(1)  256/       0 : =5AH                 tune_buzz	equ	05Ah
(1)  257/       0 : =5EH                 tune_select2	equ	05Eh
(1)  258/       0 : =6AH                 tune_shoot	equ	06Ah
(1)  259/       0 :                     
(1)  260/       0 :                     ; BIOS routines for Videopac+ G7400
(1)  261/       0 : =27DH                plusready	equ	027Dh
(1)  262/       0 : =283H                plusloadr	equ	0283h
(1)  263/       0 : =288H                pluscmd		equ	0288h
(1)  264/       0 : =28CH                plusdata	equ	028Ch
(1)  265/       0 : =296H                plushide	equ	0296h
(1)  266/       0 : =299H                plusmode	equ	0299h
(1)  267/       0 : =2A1H                plusenable	equ	02A1h
(1)  268/       0 : =2ABH                plusstart	equ	02ABh
(1)  269/       0 : =2C2H                plusselectgame	equ	02C2h
(1)  270/       0 :                     
(1)  271/       0 :                     ; registers of the EF9340/41
(1)  272/       0 : =0H                  vpp_ta_wr	equ	0
(1)  273/       0 : =1H                  vpp_tb_wr	equ	1
(1)  274/       0 : =2H                  vpp_ta_cmd	equ	2
(1)  275/       0 : =3H                  vpp_tb_cmd	equ	3
(1)  276/       0 : =4H                  vpp_ta_rd	equ	4
(1)  277/       0 : =5H                  vpp_tb_rd	equ	5
(1)  278/       0 : =6H                  vpp_busy	equ	6
(1)  279/       0 :                     ; 7 is illegal
(1)  280/       0 :                     
(1)  281/       0 :                     ; commandbytes for the Videopac+ G7400
(1)  282/       0 : =0H                  plus_cmd_brow	equ	000h	; begin row
(1)  283/       0 : =20H                 plus_cmd_loady	equ	020h	; load Y
(1)  284/       0 : =40H                 plus_cmd_loadx	equ	040h	; load X
(1)  285/       0 : =60H                 plus_cmd_incc	equ	060h	; inc C
(1)  286/       0 : =80H                 plus_cmd_loadm	equ	080h	; load M
(1)  287/       0 : =0A0H                plus_cmd_loadr	equ	0A0h	; load R
(1)  288/       0 : =0C0H                plus_cmd_loady0	equ	0C0h	; load Y0
(1)  289/       0 :                     
(1)  290/       0 :                     ; parallel attributes for the Videopac+ G7400
(1)  291/       0 :                     ; foreground color
(1)  292/       0 : =0H                  col_plus_black	equ	0
(1)  293/       0 : =1H                  col_plus_red	equ	1
(1)  294/       0 : =2H                  col_plus_green	equ	2
(1)  295/       0 : =3H                  col_plus_yellow	equ	3
(1)  296/       0 : =4H                  col_plus_blue	equ	4
(1)  297/       0 : =5H                  col_plus_violet	equ	5
 AS V1.42 Beta [Bld 213] - Source File main.asm(g7000.h) - Page 6 - 01/22/2022 23:17:32


(1)  298/       0 : =6H                  col_plus_cyan	equ	6
(1)  299/       0 : =7H                  col_plus_white	equ	7
(1)  300/       0 :                     ; background color, only parallel for block gfx
(1)  301/       0 : =0H                  col_pbck_black	equ	0 << 4
(1)  302/       0 : =10H                 col_pbck_red	equ	1 << 4
(1)  303/       0 : =20H                 col_pbck_green	equ	2 << 4
(1)  304/       0 : =30H                 col_pbck_yellow	equ	3 << 4
(1)  305/       0 : =40H                 col_pbck_blue	equ	4 << 4
(1)  306/       0 : =50H                 col_pbck_violet	equ	5 << 4
(1)  307/       0 : =60H                 col_pbck_cyan	equ	6 << 4
(1)  308/       0 : =70H                 col_pbck_white	equ	7 << 4
(1)  309/       0 :                     ; other parallel attributes
(1)  310/       0 : =80H                 col_patr_blck	equ	080h	; block gfx
(1)  311/       0 : =40H                 col_patr_invrt	equ	040h	; invert
(1)  312/       0 : =20H                 col_patr_dwdth	equ	020h	; double width
(1)  313/       0 : =10H                 col_patr_dhght	equ	010h	; double height
(1)  314/       0 : =8H                  col_patr_stable	equ	008h	; do not blink
(1)  315/       0 :                     
(1)  316/       0 :                     ; serial attributes
(1)  317/       0 :                     ; other serial attributes
(1)  318/       0 : =80H                 col_satr_enable	equ	080h	; enable serial attributes
(1)  319/       0 : =4H                  col_satr_line	equ	004h	; underline
(1)  320/       0 : =2H                  col_satr_box	equ	002h	; boxing mode
(1)  321/       0 : =1H                  col_satr_conc	equ	001h	; conceal mode
(1)  322/       0 :                     
(1)  323/       0 :                     ; block gfx
(1)  324/       0 : =40H                 plus_blck_full	equ	040h	; use full blocks
(1)  325/       0 :                     
(1)  326/       0 :                     ; parameter for plus_cmd_loadm
(1)  327/       0 : =0H                  plus_loadm_wr	equ	000h	; write
(1)  328/       0 : =20H                 plus_loadm_rd	equ	020h	; read
(1)  329/       0 : =40H                 plus_loadm_wrni	equ	040h	; write without inc
(1)  330/       0 : =60H                 plus_loadm_rdni	equ	060h	; read without inc
(1)  331/       0 : =80H                 plus_loadm_wrsl	equ	080h	; write slice
(1)  332/       0 : =0A0H                plus_loadm_rdsl	equ	0A0h	; read slice
(1)  333/       0 :                     
(1)  334/       0 :                     ; parameter for plus_cmd_loadr
(1)  335/       0 : =80H                 plus_loadr_blnk	equ	080h	; enable blink
(1)  336/       0 : =40H                 plus_loadr_tt	equ	040h	; 50/60 Hz, handled by plusloadr
(1)  337/       0 : =20H                 plus_loadr_tl	equ	020h	; monitor mode, leave 0
(1)  338/       0 : =10H                 plus_loadr_crsr	equ	010h	; display cursor
(1)  339/       0 : =8H                  plus_loadr_srow	equ	008h	; service row (first line)
(1)  340/       0 : =4H                  plus_loadr_conc	equ	004h	; show concealed
(1)  341/       0 : =2H                  plus_loadr_box	equ	002h	; box mode enable
(1)  342/       0 : =1H                  plus_loadr_dspl	equ	001h	; show display
(1)  343/       0 :                     
(1)  344/       0 :                     ; parameter for plus_cmd_loady0
(1)  345/       0 : =20H                 plus_loady0_zom	equ	020h	; global double height
(1)  346/       0 :                     
(1)  347/       0 :                     ; registers for the MegaCART/FlashCART, mirrored every 4 bytes
(1)  348/       0 : =80H                 ereg_codebank	equ	080h	; code bank
(1)  349/       0 : =81H                 ereg_databank	equ	081h	; data bank
(1)  350/       0 : =82H                 ereg_io_out	equ	082h	; output port
(1)  351/       0 : =83H                 ereg_io_in	equ	083h	; input port
(1)  352/       0 :                     
(1)  353/       0 :                     ; bits in ereg_io_out
(1)  354/       0 : =1H                  eout_tx		equ	001h	; send data from FlashCART to PC
(1)  355/       0 : =2H                  eout_eecs	equ	002h	; chip select for serial EEPROM
(1)  356/       0 : =4H                  eout_eeclk	equ	004h	; clock for serial EEPROM
(1)  357/       0 : =8H                  eout_eedi	equ	008h	; data for serial EEPROM
 AS V1.42 Beta [Bld 213] - Source File main.asm(g7000.h) - Page 7 - 01/22/2022 23:17:32


(1)  358/       0 :                     
(1)  359/       0 :                     ; bits in ereg_io_in
(1)  360/       0 : =1H                  ein_eedo	equ	001h	; data from serial EEPROM
(1)  361/       0 :                     
       4/       0 :                             include	"codepage.h"
(1)    1/       0 :                     ; http://www.atarihq.com/danb/files/o2doc.pdf#page=13&zoom=auto,-175,781
(1)    2/       0 :                     
(1)    3/       0 :                             codepage videopac
(1)    4/       0 :                     
(1)    5/       0 :                             charset '0',000h
(1)    6/       0 :                             charset '1',001h
(1)    7/       0 :                             charset '2',002h
(1)    8/       0 :                             charset '3',003h
(1)    9/       0 :                             charset '4',004h
(1)   10/       0 :                             charset '5',005h
(1)   11/       0 :                             charset '6',006h
(1)   12/       0 :                             charset '7',007h
(1)   13/       0 :                             charset '8',008h
(1)   14/       0 :                             charset '9',009h
(1)   15/       0 :                             charset 'A',020h
(1)   16/       0 :                             charset 'B',025h
(1)   17/       0 :                             charset 'C',023h
(1)   18/       0 :                             charset 'D',01ah
(1)   19/       0 :                             charset 'E',012h
(1)   20/       0 :                             charset 'F',01bh
(1)   21/       0 :                             charset 'G',01ch
(1)   22/       0 :                             charset 'H',01dh
(1)   23/       0 :                             charset 'I',016h
(1)   24/       0 :                             charset 'J',01eh
(1)   25/       0 :                             charset 'K',01fh
(1)   26/       0 :                             charset 'L',00eh
(1)   27/       0 :                             charset 'M',026h
(1)   28/       0 :                             charset 'N',02dh
(1)   29/       0 :                             charset 'O',017h
(1)   30/       0 :                             charset 'P',00fh
(1)   31/       0 :                             charset 'Q',018h
(1)   32/       0 :                             charset 'R',013h
(1)   33/       0 :                             charset 'S',019h
(1)   34/       0 :                             charset 'T',014h
(1)   35/       0 :                             charset 'U',015h
(1)   36/       0 :                             charset 'V',024h
(1)   37/       0 :                             charset 'W',011h
(1)   38/       0 :                             charset 'X',022h
(1)   39/       0 :                             charset 'Y',02ch
(1)   40/       0 :                             charset 'Z',021h
(1)   41/       0 :                             charset ' ',00ch
(1)   42/       0 :                             charset ':',00ah
(1)   43/       0 :                             charset '$',00bh
(1)   44/       0 :                             charset '?',00dh
(1)   45/       0 :                             charset '+',010h
(1)   46/       0 :                             charset '.',027h
(1)   47/       0 :                             charset '-',028h
(1)   48/       0 :                             charset '*',029h
(1)   49/       0 :                             charset '=',02bh
(1)   50/       0 :                             charset '/',02eh
(1)   51/       0 :                             charset '\\',03bh
(1)   52/       0 :                     
       5/       0 :                             include "bitfuncs.inc"
(1)    1/       0 : =>UNDEFINED          		ifndef   bitfuncsinc    ; avoid multiple inclusion
(1)    2/       0 : =1H                  bitfuncsinc     equ      1
 AS V1.42 Beta [Bld 213] - Source File main.asm(bitfuncs.inc) - Page 8 - 01/22/2022 23:17:32


(1)    3/       0 :                     
(1)    4/       0 :                                     save
(1)   77/       0 : ALL                                  restore                 ; allow listing again
(1)   78/       0 :                     
(1)   79/       0 : [1]                                  endif			; bitfuncsinc
(1)   80/       0 :                     
(1)   81/       0 :                     
       6/       0 :                     
       7/       0 :                     ;-----------------
       8/       0 :                     ; Macros
       9/       0 :                     ;-----------------
      10/       0 :                     
      11/       0 :                     ; Turn on debugging colors
      12/       0 :                     ; DEBUG_COLORS equ 1
      13/       0 :                     
      14/       0 :                     inline_external_vdc macro
      15/       0 :                             orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
      16/       0 :                             anl p1,#0b7h                      ; clear : !vdcen copyen (?)
      17/       0 :                         endm
      18/       0 :                     
      19/       0 :                     inline_external_ram macro
      20/       0 :                             orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
      21/       0 :                             anl p1,#0afh                      ; clear : !ramen copyen
      22/       0 :                         endm
      23/       0 :                     
      24/       0 :                     disable_vdc_foreground macro
      25/       0 :                             mov r0, #0a0h
      26/       0 :                             mov a,#8|128
      27/       0 :                             movx @r0,a
      28/       0 :                         endm
      29/       0 :                     
      30/       0 :                     enable_vdc_foreground macro
      31/       0 :                             mov r0, #0a0h
      32/       0 :                             mov a,#8|32|128
      33/       0 :                             movx @r0,a
      34/       0 :                         endm
      35/       0 :                     
      36/       0 :                     calc_char_2 function c, color, row, lo((c << 3) - 16 - (row*10))
      37/       0 :                     calc_char_3 function c, color, row, col | getbit((c << 3) - 16 - (row*10), 8)
      38/       0 :                     
      39/       0 :                     sleep_nop macro count
      40/       0 :                         rept count
      41/       0 :                             nop
      42/       0 :                         endm
      43/       0 :                         endm
      44/       0 :                     
      45/       0 :                     sleep_loop macro reg, count
      46/       0 :                         if count < 5
      47/       0 :                             sleep_nop count
      48/       0 :                         else
      49/       0 :                             if ((count - 2) # 2) == 1
      50/       0 :                                 nop
      51/       0 :                             endif
      52/       0 :                                 mov reg,#((count - 2) / 2)
      53/       0 :                             -:
      54/       0 :                                 djnz reg,-
      55/       0 :                         endif
      56/       0 :                         endm
      57/       0 :                     
      58/       0 : =0H                  TILE_WHITE      equ 00b
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 9 - 01/22/2022 23:17:32


      59/       0 : =1H                  TILE_RED        equ 01b
      60/       0 : =2H                  TILE_GREEN      equ 10b
      61/       0 : =3H                  TILE_BLUE       equ 11b
      62/       0 :                     
      63/       0 :                     read_extram_char macro x, y
      64/       0 :                             mov r0, #x + (y * 12)
      65/       0 :                             movx a, @r0
      66/       0 :                             rr a
      67/       0 :                             rr a
      68/       0 :                             rr a
      69/       0 :                             anl a, #00111111b
      70/       0 :                         endm
      71/       0 :                     
      72/       0 :                     calc_extram_char function char, color, rotln((char << 2) | color, 8, 1)
      73/       0 :                     
      74/       0 :                     write_extram_char macro char, x, y, color
      75/       0 :                             mov a, #rotln((char << 2) | color, 8, 1)
      76/       0 :                             mov r0, #x + (y * 12)
      77/       0 :                             movx @r0, a
      78/       0 :                         endm
      79/       0 :                     
      80/       0 :                     write_extram_string macro str, x, y, color
      81/       0 :                             mov r0, #x + (y * 12)
      82/       0 :                     .cnt set 0
      83/       0 :                             while .cnt < STRLEN(str)
      84/       0 :                                 mov a, #rotln(lo(SUBSTR(str, .cnt, 1) << 2) | color, 8, 1)
      85/       0 :                                 movx @r0, a
      86/       0 :                                 inc r0
      87/       0 :                     .cnt set .cnt + 1
      88/       0 :                             endm
      89/       0 :                         endm
      90/       0 :                     
      91/       0 :                     assert macro expr
      92/       0 :                             if (~~val(expr))
      93/       0 :                                 error expr
      94/       0 :                             endif
      95/       0 :                         endm
      96/       0 :                     
      97/       0 :                     ;-----------------
      98/       0 :                     ; Internal RAM values
      99/       0 :                     ;-----------------
     100/       0 :                     
     101/       0 :                     ; stuff values in top of stack
     102/       0 : =16H                 iram_vblank_bkp_a           equ 016h
     103/       0 : =17H                 iram_vblank_bkp_p1          equ 017h
     104/       0 :                     
     105/       0 : =20H                 iram_tile_compute_start     equ 020h
     106/       0 : =35H                 iram_tile_compute_end       equ 035h
     107/       0 : =36H                 iram_rewrite_start          equ 036h
     108/       0 : =39H                 iram_rewrite_end            equ 039h
     109/       0 : =3AH                 iram_iram_index             equ 03ah
     110/       0 : =3BH                 iram_keyboard               equ 03bh
     111/       0 :                     
     112/       0 :                     ; unused
     113/       0 : =3CH                 iram_ictrl	    equ	03ch	    ; control irq
     114/       0 : =3DH                 iram_random     equ 03dh
     115/       0 :                     ; 03d-03f are reserved from BIOS
     116/       0 :                     
     117/       0 :                     ; Flag values
     118/       0 : =80H                 ictrl_nextframe	            equ	080h	    ; if set, do the blinking
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 10 - 01/22/2022 23:17:32


     119/       0 : =40H                 ictrl_lineirq	            equ	040h	    ; if set, do the lineirq
     120/       0 : =20H                 ictrl_gameover              equ 020h        ; if set, game over
     121/       0 :                     
     122/       0 :                     
     123/       0 : =68H                 TEXT_XPOS       equ 68h
     124/       0 : =28H                 TEXT_XPOS2      equ 28h
     125/       0 :                     
     126/       0 :                     ; Y offsets
     127/       0 : =0CH                 TEXT_HI_YPOS                    equ 0x0c
     128/       0 : =0FFFFFFFFFFFFFFF0H  TIMING_Y_START_OFFSET           equ -((TEXT_HI_YPOS / 2) + 10)
     129/       0 : =0F4H                TIMING_SCANLINE_START           equ 0x100 - TEXT_HI_YPOS
     130/       0 :                     
     131/       0 :                     ; Timing constants for kernel
     132/       0 : =13H                 TIMING_CYCLES_TO_FIRST_ROW      equ 19
     133/       0 : =29H                 TIMING_AFTER_COMPUTE            equ 41
     134/       0 : =2H                  TIMING_VDC_WRITE_PADDING        equ 2
     135/       0 :                     
     136/       0 :                     
     137/       0 :                     ;-----------------
     138/       0 :                     ; Program start
     139/       0 :                     ;-----------------
     140/       0 :                     
     141/     400 :                             org	400h
     142/     400 :                     
     143/     400 : 44 C3                       jmp	selectgame	; RESET
     144/     402 : 04 09                       jmp	irq		    ; interrupt
     145/     404 : A4 90                       jmp	timeirq		; timer
     146/     406 : 84 C0                       jmp	myvsyncirq	; VSYNC-interrupt
     147/     408 : 84 0C                       jmp	bank0_start	; after selectgame
     148/     40A : 04 44                       jmp	soundirq	; sound-interrupt
     149/     40C :                     
     150/     40C :                     bank0_start:
     151/     40C :                             ; initialise variables
     152/     40C : B8 3C                       mov	r0,#iram_ictrl
     153/     40E : 23 00                       mov	a,#0		; don't blink yet
     154/     410 : A0                          mov	@r0,a
     155/     411 :                     
     156/     411 :                             ; activate line irq
     157/     411 : B8 3C                       mov	r0,#iram_ictrl
     158/     413 : 23 40                       mov	a,#ictrl_lineirq
     159/     415 : A0                          mov	@r0,a
     160/     416 :                     
     161/     416 :                             ; turn grid gfx off, the bios-routine is not safe
     162/     416 :                             ; to use in irq, it leaves with RB1 and EN I
     163/     416 :                             ; sel rb0
     164/     416 :                             ; mov	r0,#vdc_control
     165/     416 :                             ; movx	a,@r0
     166/     416 :                             ; ; mov	@r1,a		; store old vdc_control
     167/     416 :                             ; orl	a,#2 | 080h
     168/     416 :                             ; movx	@r0,a
     169/     416 :                             ; sel rb1
     170/     416 :                     
     171/     416 :                             ; Prepare for graphics initialization
     172/     416 : 34 1C                       call	gfxoff
     173/     418 :                     
     174/     418 :                     
     175/     418 :                             ; Write some characters to display on-screen
     176/     418 :                     write_extram_char_bytes:
     177/     418 : (MACRO)                      inline_external_ram
     177/     418 : 89 BC                       orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 11 - 01/22/2022 23:17:32


     177/     41A : 99 AF                       anl p1,#0afh                      ; clear : !ramen copyen
     178/     41C :                         
     179/     41C : BA 70                       mov r2, #112
     180/     41E :                         .write_to_external_ram:
     181/     41E : FA                          mov a, r2
     182/     41F : 07                          dec a
     183/     420 : A8                          mov r0, a
     184/     421 : FA                          mov a, r2
     185/     422 : 07                          dec a
     186/     423 :                             ; mov a, #55
     187/     423 :                             ; mov a, #' '
     188/     423 : 53 3F                       anl a, #63
     189/     425 : E7                          rl a
     190/     426 : E7                          rl a
     191/     427 : 43 03                       orl a, #3     ; make it green
     192/     429 : E7                          rl a
     193/     42A : 90                          movx @r0, a
     194/     42B :                         .also_check_if_not_zero:
     195/     42B : EA 1E                       djnz r2, .write_to_external_ram
     196/     42D :                     
     197/     42D : (MACRO)                      inline_external_vdc
     197/     42D : 89 BC                       orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
     197/     42F : 99 B7                       anl p1,#0b7h                      ; clear : !vdcen copyen (?)
     198/     431 :                     
     199/     431 :                     
     200/     431 :                     init_grid:
     201/     431 :                             ; Initialize the vertical grid which serves as our full color background
     202/     431 : B8 E2                       mov	r0, #vdc_gridv0+2
     203/     433 : BA 06                       mov	r2, #6
     204/     435 :                         .loopgv:
     205/     435 : 23 81                       mov	a, #10000001b		; get value
     206/     437 : 90                          movx @r0,a		    ; store in vdc
     207/     438 : 18                          inc	r0
     208/     439 : EA 35                       djnz r2, .loopgv
     209/     43B :                     
     210/     43B :                             ; left
     211/     43B : B8 E1                       mov	r0, #vdc_gridv0+1
     212/     43D : 23 FF                       mov	a, #11111111b		; get value
     213/     43F : 90                          movx @r0,a		    ; store in vdc
     214/     440 :                     
     215/     440 :                             ; right
     216/     440 : B8 E8                       mov	r0, #vdc_gridv0+8
     217/     442 : 23 FF                       mov	a, #11111111b		; get value
     218/     444 : 90                          movx @r0,a		    ; store in vdcv
     219/     445 :                     
     220/     445 :                     init_text:
     221/     445 :                             ; Draw text
     222/     445 :                             ; call draw_helloworld
     223/     445 : 94 4A                       call draw_helloworld
     224/     447 :                     
     225/     447 :                             ; Re-enable graphics
     226/     447 :                             ; call gfxon
     227/     447 :                     
     228/     447 :                             ; Start program
     229/     447 : F5 04 00                    jmp main
     230/     44A :                     
     231/     44A :                     
     232/     44A :                     ;------------------------------
     233/     44A :                     ; Quads and text
     234/     44A :                     ;------------------------------
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 12 - 01/22/2022 23:17:32


     235/     44A :                     
     236/     44A :                     draw_helloworld:
     237/     44A : B8 40                       mov     r0,#vdc_quad0       ; start char
     238/     44C : BB 28                       mov     r3,#TEXT_XPOS2       ; x-position
     239/     44E : BC 20                       mov     r4,#TEXT_HI_YPOS+20    ; y-position
     240/     450 : BA 0C                       mov     r2,#0ch             ; length
     241/     452 : B9 B2                       mov     r1,#hellostr & 0FFh ; the string to print
     242/     454 :                                                         ; must be in the same page
     243/     454 :                         .loop:
     244/     454 : F9                          mov     a,r1                ; get pointer
     245/     455 : A3                          movp    a,@a                ; get char
     246/     456 : AD                          mov     r5,a                ; into to right register
     247/     457 : 19                          inc     r1                  ; advance pointer
     248/     458 : BE 0E                       mov     r6,#col_chr_white   ; colour
     249/     45A : 74 EA                       call    printchar           ; print it
     250/     45C : EA 54                       djnz    r2,.loop             ; do it again
     251/     45E :                     
     252/     45E : 23 68                       mov     a,#TEXT_XPOS       ; x-position
     253/     460 : B8 6D                       mov     r0,#vdc_quad2+12+1
     254/     462 : 90                          movx     @r0, a
     255/     463 :                     
     256/     463 : =>UNDEFINED              ifdef DEBUG_COLORS
     257/     463 :                             mov a, #1101b
     258/     463 : =>TRUE                   else
     259/     463 : 23 00                       mov a, #0000b
     260/     465 : [256]                    endif
     261/     465 : B8 6B                       mov r0, #vdc_quad2+8+3
     262/     467 : 90                          movx @r0,a
     263/     468 : B8 6F                       mov r0, #vdc_quad2+12+3
     264/     46A : 90                          movx @r0,a
     265/     46B :                     
     266/     46B :                         ; ifdef DEBUG_COLORS
     267/     46B :                         ;     ; draw a white block at the top left using the unused quad
     268/     46B :                         ;     ; to show when VDC writing ends
     269/     46B :                         ;     ; (this won't work on a real console since it uses overlap)
     270/     46B :                         ;     mov     r0,#vdc_quad3+0       ; last quad char
     271/     46B :                         ;     mov     r3,#24                  ; x-position
     272/     46B :                         ;     mov     r4,#TEXT_HI_YPOS + 20    ; y-position
     273/     46B :                         ;     mov     r5,#47
     274/     46B :                         ;     call printchar
     275/     46B :                         ;     mov     r0,#vdc_quad3+4       ; last quad char
     276/     46B :                         ;     mov     r4,#TEXT_HI_YPOS + 20    ; y-position
     277/     46B :                         ;     mov     r5,#' '
     278/     46B :                         ;     call printchar
     279/     46B :                         ;     mov     r0,#vdc_quad3+8       ; last quad char
     280/     46B :                         ;     mov     r4,#TEXT_HI_YPOS + 20    ; y-position
     281/     46B :                         ;     mov     r5,#' '
     282/     46B :                         ;     call printchar
     283/     46B :                         ;     mov     r0,#vdc_quad3+12       ; last quad char
     284/     46B :                         ;     mov     r4,#TEXT_HI_YPOS + 20    ; y-position
     285/     46B :                         ;     mov     r5,#' '
     286/     46B :                         ;     call printchar
     287/     46B :                         ; endif
     288/     46B :                     
     289/     46B : B8 70                       mov     r0,#vdc_quad3+0
     290/     46D : BB 70                       mov     r3,#112
     291/     46F : BC 98                       mov     r4,#TEXT_HI_YPOS + (20 * 7)    ; y-position
     292/     471 : BD 20                       mov     r5,#'A'
     293/     473 : 74 EA                       call printchar
     294/     475 :                     
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 13 - 01/22/2022 23:17:32


     295/     475 : B8 78                       mov     r0,#vdc_quad3+8
     296/     477 : BB 70                       mov     r3,#112
     297/     479 : BC 98                       mov     r4,#TEXT_HI_YPOS + (20 * 7)    ; y-position
     298/     47B : BD 0C                       mov     r5,#' '
     299/     47D : 74 EA                       call printchar
     300/     47F :                     
     301/     47F : B8 7C                       mov     r0,#vdc_quad3+12
     302/     481 : BB 70                       mov     r3,#112
     303/     483 : BC 98                       mov     r4,#TEXT_HI_YPOS + (20 * 7)    ; y-position
     304/     485 : BD 0C                       mov     r5,#' '
     305/     487 : 74 EA                       call printchar
     306/     489 :                     
     307/     489 :                             ; Position the twelve chars for columns 9 of 12
     308/     489 : B8 10                       mov r0, #vdc_char0
     309/     48B : B9 0C                       mov r1, #TEXT_HI_YPOS
     310/     48D : BA 06                       mov r2, #6
     311/     48F :                         .column_9:
     312/     48F : BB 70                       mov r3, #112       ; x-position
     313/     491 : 23 14                       mov a, #20
     314/     493 : 69                          add a, r1
     315/     494 : A9                          mov r1, a
     316/     495 : AC                          mov r4, a
     317/     496 : BD 2F                       mov r5, #47
     318/     498 : 74 EA                       call printchar
     319/     49A : 1B                          inc r3
     320/     49B : EA 8F                       djnz r2, .column_9
     321/     49D :                     
     322/     49D :                             ; Position the twelve chars for columns 11 of 12
     323/     49D : B8 28                       mov r0, #vdc_char6
     324/     49F : B9 0C                       mov r1, #TEXT_HI_YPOS
     325/     4A1 : BA 06                       mov r2, #6
     326/     4A3 :                         .column_11:
     327/     4A3 : BB 80                       mov r3, #128        ; x-position
     328/     4A5 : 23 14                       mov a, #20
     329/     4A7 : 69                          add a, r1
     330/     4A8 : A9                          mov r1, a
     331/     4A9 : AC                          mov r4, a
     332/     4AA : BD 2F                       mov r5, #47
     333/     4AC : 74 EA                       call printchar
     334/     4AE : 1B                          inc r3
     335/     4AF : EA A3                       djnz r2, .column_11
     336/     4B1 :                     
     337/     4B1 : 93                          retr
     338/     4B2 :                     
     339/     4B2 :                     
     340/     4B2 :                     hellostr
     341/     4B2 : 23 20 20 14 1D 13           db      "CAATHRCER1234"
              4B8 : 23 12 13 01 02 03 
              4BE : 04                
     342/     4BF :                     
     343/     4BF :                     ;----------------------
     344/     4BF :                     ; VSync IRQ
     345/     4BF :                     ;----------------------
     346/     4BF :                     
     347/     4BF :                             align 16
     348/     4C0 :                     
     349/     4C0 :                     ; it starts the lineirq and does the blinking
     350/     4C0 :                     myvsyncirq
     351/     4C0 :                             ; start lineirq, if needed
     352/     4C0 : B8 3C                       mov	r0,#iram_ictrl	; control register
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 14 - 01/22/2022 23:17:32


     353/     4C2 : F0                          mov	a,@r0
     354/     4C3 : 37                          cpl	a
     355/     4C4 : D2 C8                       jb6	.skip_line_irq	; should we start line irq ?
     356/     4C6 : 84 CF                       jmp .setup_frame
     357/     4C8 :                     
     358/     4C8 :                         .skip_line_irq:
     359/     4C8 :                             ; set grid+background color
     360/     4C8 : B8 A3                       mov	r0,#vdc_color
     361/     4CA : 23 0D                       mov	a,#col_grd_violet | col_bck_blue
     362/     4CC : 90                          movx	@r0,a
     363/     4CD :                     
     364/     4CD : 04 1A                       jmp	vsyncirq	; thats all for now
     365/     4CF :                     
     366/     4CF :                         .setup_frame:
     367/     4CF : F0                          mov	a,@r0
     368/     4D0 : 23 F4                       mov	a,#TIMING_SCANLINE_START		; middle of the screen
     369/     4D2 : 62                          mov	t,a		    ; set # of lines to wait
     370/     4D3 : 45                          strt	cnt		; start line counting
     371/     4D4 : 25                          en	tcnti		; enable timer irq
     372/     4D5 :                     
     373/     4D5 :                             ; select base register set(?)
     374/     4D5 : C5                          sel	rb0
     375/     4D6 :                     
     376/     4D6 :                             ; set grid+background color
     377/     4D6 : B8 A3                       mov	r0,#vdc_color
     378/     4D8 : 23 07                       mov	a,#col_grd_white | col_bck_black
     379/     4DA : 90                          movx	@r0,a
     380/     4DB :                     
     381/     4DB :                             ; Clear sound registers
     382/     4DB : 27                          clr a
     383/     4DC : B8 3F                       mov r0, #iram_irqctrl
     384/     4DE : A0                          mov @r0, a
     385/     4DF : B8 AA                       mov r0, #vdc_soundctrl
     386/     4E1 : 90                          movx @r0, a
     387/     4E2 :                     
     388/     4E2 :                             ; Read joystick bit pattern
     389/     4E2 : B9 00                       mov r1, #0
     390/     4E4 : 74 8F                       call getjoystick
     391/     4E6 : F9                          mov a, r1
     392/     4E7 : 37                          cpl a
     393/     4E8 : AA                          mov r2, a
     394/     4E9 : B9 3B                       mov r1, #iram_keyboard
     395/     4EB : F1                          mov a, @r1
     396/     4EC : 4A                          orl a, r2
     397/     4ED : A1                          mov @r1, a
     398/     4EE :                     
     399/     4EE :                             ; Write columns 9 and 11 chars
     400/     4EE :                         .write_individual_chars:
     401/     4EE : (MACRO)                      disable_vdc_foreground
     401/     4EE : B8 A0                       mov r0, #0a0h
     401/     4F0 : 23 88                       mov a,#8|128
     401/     4F2 : 90                          movx @r0,a
     402/     4F3 : 89 7C                       orl p1,#07ch                      ; set : !kbscan !vdcen !ramen copyen
     403/     4F5 : 99 E7                       anl p1,#0e7h                      ; clear : !vdcen !ramen
     404/     4F7 :                     
     405/     4F7 : =0H                  .count set 0
     406/     4F7 :                         while .count < 6
     407/     4F7 :                             ; column 9
     408/     4F7 :                             mov r0, #vdc_char0 + 2 + (.count * 4)
     409/     4F7 :                             mov r1, #9 + (.count * 12)
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 15 - 01/22/2022 23:17:32


     410/     4F7 :                             mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     411/     4F7 :                             call compute_char_from_extram
     412/     4F7 :                     
     413/     4F7 :                             ; column 11
     414/     4F7 :                             mov r0, #vdc_char6 + 2 + (.count * 4)
     415/     4F7 :                             mov r1, #11 + (.count * 12)
     416/     4F7 :                             mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     417/     4F7 :                             call compute_char_from_extram
     418/     4F7 :                     .count set .count + 1
     419/     4F7 :                         endm
     407/     4F7 :                             ; column 9
     408/     4F7 : B8 12                       mov r0, #vdc_char0 + 2 + (.count * 4)
     409/     4F9 : B9 09                       mov r1, #9 + (.count * 12)
     410/     4FB : BD F0                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     411/     4FD : D4 0A                       call compute_char_from_extram
     412/     4FF :                     
     413/     4FF :                             ; column 11
     414/     4FF : B8 2A                       mov r0, #vdc_char6 + 2 + (.count * 4)
     415/     501 : B9 0B                       mov r1, #11 + (.count * 12)
     416/     503 : BD F0                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     417/     505 : D4 0A                       call compute_char_from_extram
     418/     507 : =1H                  .count set .count + 1
     407/     507 :                             ; column 9
     408/     507 : B8 16                       mov r0, #vdc_char0 + 2 + (.count * 4)
     409/     509 : B9 15                       mov r1, #9 + (.count * 12)
     410/     50B : BD E6                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     411/     50D : D4 0A                       call compute_char_from_extram
     412/     50F :                     
     413/     50F :                             ; column 11
     414/     50F : B8 2E                       mov r0, #vdc_char6 + 2 + (.count * 4)
     415/     511 : B9 17                       mov r1, #11 + (.count * 12)
     416/     513 : BD E6                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     417/     515 : D4 0A                       call compute_char_from_extram
     418/     517 : =2H                  .count set .count + 1
     407/     517 :                             ; column 9
     408/     517 : B8 1A                       mov r0, #vdc_char0 + 2 + (.count * 4)
     409/     519 : B9 21                       mov r1, #9 + (.count * 12)
     410/     51B : BD DC                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     411/     51D : D4 0A                       call compute_char_from_extram
     412/     51F :                     
     413/     51F :                             ; column 11
     414/     51F : B8 32                       mov r0, #vdc_char6 + 2 + (.count * 4)
     415/     521 : B9 23                       mov r1, #11 + (.count * 12)
     416/     523 : BD DC                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     417/     525 : D4 0A                       call compute_char_from_extram
     418/     527 : =3H                  .count set .count + 1
     407/     527 :                             ; column 9
     408/     527 : B8 1E                       mov r0, #vdc_char0 + 2 + (.count * 4)
     409/     529 : B9 2D                       mov r1, #9 + (.count * 12)
     410/     52B : BD D2                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     411/     52D : D4 0A                       call compute_char_from_extram
     412/     52F :                     
     413/     52F :                             ; column 11
     414/     52F : B8 36                       mov r0, #vdc_char6 + 2 + (.count * 4)
     415/     531 : B9 2F                       mov r1, #11 + (.count * 12)
     416/     533 : BD D2                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     417/     535 : D4 0A                       call compute_char_from_extram
     418/     537 : =4H                  .count set .count + 1
     407/     537 :                             ; column 9
     408/     537 : B8 22                       mov r0, #vdc_char0 + 2 + (.count * 4)
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 16 - 01/22/2022 23:17:32


     409/     539 : B9 39                       mov r1, #9 + (.count * 12)
     410/     53B : BD C8                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     411/     53D : D4 0A                       call compute_char_from_extram
     412/     53F :                     
     413/     53F :                             ; column 11
     414/     53F : B8 3A                       mov r0, #vdc_char6 + 2 + (.count * 4)
     415/     541 : B9 3B                       mov r1, #11 + (.count * 12)
     416/     543 : BD C8                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     417/     545 : D4 0A                       call compute_char_from_extram
     418/     547 : =5H                  .count set .count + 1
     407/     547 :                             ; column 9
     408/     547 : B8 26                       mov r0, #vdc_char0 + 2 + (.count * 4)
     409/     549 : B9 45                       mov r1, #9 + (.count * 12)
     410/     54B : BD BE                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     411/     54D : D4 0A                       call compute_char_from_extram
     412/     54F :                     
     413/     54F :                             ; column 11
     414/     54F : B8 3E                       mov r0, #vdc_char6 + 2 + (.count * 4)
     415/     551 : B9 47                       mov r1, #11 + (.count * 12)
     416/     553 : BD BE                       mov r5, #TIMING_Y_START_OFFSET - (.count * 10)
     417/     555 : D4 0A                       call compute_char_from_extram
     418/     557 : =6H                  .count set .count + 1
     407/     557 :                     
     420/     557 :                     
     421/     557 :                             ; quad 4 on row 7
     422/     557 : B8 72                       mov r0, #vdc_quad3 + 0 + 2
     423/     559 : B9 51                       mov r1, #9 + (6 * 12)
     424/     55B : BD B4                       mov r5, #TIMING_Y_START_OFFSET - (6 * 10)
     425/     55D : D4 0A                       call compute_char_from_extram
     426/     55F :                             ; quad 4 on row 7
     427/     55F : B8 76                       mov r0, #vdc_quad3 + 4 + 2
     428/     561 : B9 53                       mov r1, #11 + (6 * 12)
     429/     563 : BD B4                       mov r5, #TIMING_Y_START_OFFSET - (6 * 10)
     430/     565 : D4 0A                       call compute_char_from_extram
     431/     567 :                     
     432/     567 :                             ; calculate the last entries for columns 9 and 11
     433/     567 : B8 36                       mov r0, #iram_rewrite_start
     434/     569 : B9 5D                       mov r1, #9 + (7 * 12)
     435/     56B : BD AA                       mov r5, #TIMING_Y_START_OFFSET - (7 * 10)
     436/     56D : D4 1D                       call compute_char_from_extram_mov
     437/     56F : B9 5F                       mov r1, #11 + (7 * 12)
     438/     571 : BD AA                       mov r5, #TIMING_Y_START_OFFSET - (7 * 10)
     439/     573 : D4 1D                       call compute_char_from_extram_mov
     440/     575 :                     
     441/     575 : B8 10                       mov r0, #vdc_char0
     442/     577 : 23 20                       mov a, #TEXT_HI_YPOS + (20 * 1)
     443/     579 : 90                          movx @r0, a
     444/     57A : B8 28                       mov r0, #vdc_char6
     445/     57C : 23 20                       mov a, #TEXT_HI_YPOS + (20 * 1)
     446/     57E : 90                          movx @r0, a
     447/     57F :                     
     448/     57F : 89 BC                       orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
     449/     581 : 99 B7                       anl p1,#0b7h                      ; clear : !vdcen copyen
     450/     583 : (MACRO)                      enable_vdc_foreground
     450/     583 : B8 A0                       mov r0, #0a0h
     450/     585 : 23 A8                       mov a,#8|32|128
     450/     587 : 90                          movx @r0,a
     451/     588 :                     
     452/     588 :                         .continue_vblank_irq:
     453/     588 :                             ; continue BIOS IRQ routine
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 17 - 01/22/2022 23:17:32


     454/     588 : 93                          retr
     455/     589 :                     
     456/     589 :                     
     457/     589 :                     ;----------------------
     458/     589 :                     ; Line IRQ
     459/     589 :                     ;----------------------
     460/     589 :                     
     461/     589 :                             align 16
     462/     590 :                     
     463/     590 :                     timeirq:
     464/     590 :                             ; select base register set(?)
     465/     590 : C5                          sel	rb0
     466/     591 :                             ; stop timer
     467/     591 : 65                          stop	tcnt
     468/     592 :                     
     469/     592 :                             ; backup a
     470/     592 : B8 16                       mov r0, #iram_vblank_bkp_a
     471/     594 : A0                          mov	@r0,a
     472/     595 :                             ; Backup P1
     473/     595 : 09                          in	a,P1
     474/     596 : B8 17                       mov r0, #iram_vblank_bkp_p1
     475/     598 : A0                          mov	@r0,a
     476/     599 :                     
     477/     599 :                             ; Enable VDC in extram
     478/     599 : (MACRO)                      inline_external_vdc
     478/     599 : 89 BC                       orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
     478/     59B : 99 B7                       anl p1,#0b7h                      ; clear : !vdcen copyen (?)
     479/     59D :                     
     480/     59D :                             ; r2 = eventual computed space character for quad2 each row
     481/     59D : BA 00                       mov r2, #0
     482/     59F :                             ; r3 = index into extram
     483/     59F : B8 3A                       mov r0, #iram_iram_index
     484/     5A1 : 23 00                       mov a, #0
     485/     5A3 : A0                          mov @r0, a
     486/     5A4 :                             ; mov r4, #111b
     487/     5A4 :                             ; r5 = "Y offset" to add to VDC character writes
     488/     5A4 : BD F0                       mov r5, #TIMING_Y_START_OFFSET
     489/     5A6 :                             ; r6 = Y position to write to quads
     490/     5A6 : BE 0C                       mov r6, #TEXT_HI_YPOS
     491/     5A8 :                             ; r7 = row counter
     492/     5A8 :                             ; mov r7, #08h
     493/     5A8 :                     
     494/     5A8 :                             ; Wait until the first row should start
     495/     5A8 : (MACRO)                      sleep_loop r0, TIMING_CYCLES_TO_FIRST_ROW
     495/     5A8 : =>FALSE                  if TIMING_CYCLES_TO_FIRST_ROW < 5
     495/     5A8 :                             sleep_nop TIMING_CYCLES_TO_FIRST_ROW
     495/     5A8 : =>TRUE                   else
     495/     5A8 : =>TRUE                       if ((TIMING_CYCLES_TO_FIRST_ROW - 2) # 2) == 1
     495/     5A8 : 00                              nop
     495/     5A9 : [495]                        endif
     495/     5A9 : B8 08                           mov R0,#((TIMING_CYCLES_TO_FIRST_ROW - 2) / 2)
     495/     5AB :                             -:
     495/     5AB : E8 AB                           djnz R0,-
     495/     5AD : [495]                    endif
     496/     5AD :                     
     497/     5AD :                             ; Render all eight rows
     498/     5AD : BB FF                       mov r3, #0ffh
     499/     5AF : BC FF                       mov r4, #0ffh
     500/     5B1 : 00                          nop
     501/     5B2 : 00                          nop
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 18 - 01/22/2022 23:17:32


     502/     5B3 : D4 30                       call compute_chars
     503/     5B5 : BB 10                       mov r3, #vdc_char0
     504/     5B7 : BC AC                       mov r4, #TEXT_HI_YPOS + (20 * 8)
     505/     5B9 : 00                          nop
     506/     5BA : 00                          nop
     507/     5BB : D4 30                       call compute_chars
     508/     5BD : BB 28                       mov r3, #vdc_char6
     509/     5BF : BC AC                       mov r4, #TEXT_HI_YPOS + (20 * 8)
     510/     5C1 : 00                          nop
     511/     5C2 : 00                          nop
     512/     5C3 : D4 30                       call compute_chars
     513/     5C5 : BB 12                       mov r3, #vdc_char0+2+0
     514/     5C7 : B8 36                       mov r0, #iram_rewrite_start+0
     515/     5C9 : F0                          mov a, @r0
     516/     5CA : AC                          mov r4, a
     517/     5CB : D4 30                       call compute_chars
     518/     5CD : BB 13                       mov r3, #vdc_char0+2+1
     519/     5CF : B8 37                       mov r0, #iram_rewrite_start+1
     520/     5D1 : F0                          mov a, @r0
     521/     5D2 : AC                          mov r4, a
     522/     5D3 : D4 30                       call compute_chars
     523/     5D5 : BB 2A                       mov r3, #vdc_char6+2+0
     524/     5D7 : B8 38                       mov r0, #iram_rewrite_start+2
     525/     5D9 : F0                          mov a, @r0
     526/     5DA : AC                          mov r4, a
     527/     5DB : D4 30                       call compute_chars
     528/     5DD : BB 2B                       mov r3, #vdc_char6+2+1
     529/     5DF : B8 39                       mov r0, #iram_rewrite_start+3
     530/     5E1 : F0                          mov a, @r0
     531/     5E2 : AC                          mov r4, a
     532/     5E3 : D4 30                       call compute_chars
     533/     5E5 :                             ; noop
     534/     5E5 : BB FF                       mov r3, #0ffh
     535/     5E7 : BC FF                       mov r4, #0ffh
     536/     5E9 : 00                          nop
     537/     5EA : 00                          nop
     538/     5EB : D4 30                       call compute_chars
     539/     5ED :                     
     540/     5ED :                         .finish_frame:
     541/     5ED :                             ; Set the "frame done" flag
     542/     5ED : B8 3C                       mov r0, #iram_ictrl
     543/     5EF : F0                          mov a, @r0
     544/     5F0 :                             ; orl a, #ictrl_nextframe
     545/     5F0 : 23 FF                       mov a, #$ff
     546/     5F2 : A0                          mov @r0, a
     547/     5F3 :                     
     548/     5F3 :                             ; We're done, reset registers
     549/     5F3 :                             ; Reset P1
     550/     5F3 : B8 17                       mov r0, #iram_vblank_bkp_p1
     551/     5F5 : F0                          mov	a, @r0
     552/     5F6 : 39                          outl	P1,a
     553/     5F7 :                             ; Reset a
     554/     5F7 : B8 16                       mov r0, #iram_vblank_bkp_a
     555/     5F9 : F0                          mov	a,@r0
     556/     5FA :                     
     557/     5FA :                             ; Set extram enabled
     558/     5FA :                             ; TODO: why is this necessary if we cache P1??
     559/     5FA : (MACRO)                      inline_external_ram
     559/     5FA : 89 BC                       orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
     559/     5FC : 99 AF                       anl p1,#0afh                      ; clear : !ramen copyen
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 19 - 01/22/2022 23:17:32


     560/     5FE :                     
     561/     5FE : 93                          retr
     562/     5FF :                     
     563/     5FF :                     
     564/     5FF :                     ;------------------------------------------
     565/     5FF :                     ; Compute next row's chars, store in scratchpad ram
     566/     5FF :                     ;------------------------------------------
     567/     5FF :                     
     568/     5FF :                             ; Align to page, since we use "movp a, @a" to lookup constants at start of page
     569/     5FF :                             align 256
     570/     600 :                     
     571/     600 :                     compute_page:
     572/     600 :                             ; color map from two bit reference => three bit color
     573/     600 :                             ; (we preserve the lowest bit of the three-bit lookup value
     574/     600 :                             ; since it's actually bit 9 of the character value)
     575/     600 : 0E 0F                       db col_chr_white | 0, col_chr_white | 1
     576/     602 : 02 03                       db col_chr_red | 0, col_chr_red | 1
     577/     604 : 04 05                       db col_chr_green | 0, col_chr_green | 1
     578/     606 : 06 07                       db col_chr_yellow | 0, col_chr_yellow | 1
     579/     608 :                     
     580/     608 :                             ; Load color from table
     581/     608 :                             ; a = tile color << 1
     582/     608 :                             ; out a = three bit color << 1
     583/     608 :                     compute_color:
     584/     608 : A3                          movp a, @a
     585/     609 : 93                          retr
     586/     60A :                     
     587/     60A :                     compute_char_macro macro opcode
     588/     60A :                             ; Load character byte (shifted left twice)
     589/     60A :                             movx a, @r1
     590/     60A :                             ; cut out the lower three bits
     591/     60A :                             anl a, #111b
     592/     60A :                             ; lookup in the color table and store temporarily in r7
     593/     60A :                             movp a, @a
     594/     60A :                             mov r7, a
     595/     60A :                     
     596/     60A :                             ; cut out the upper five bits
     597/     60A :                             movx a, @r1
     598/     60A :                             anl a, #11111000b
     599/     60A :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     600/     60A :                             add a, r5
     601/     60A :                             ; write char value to the odd byte
     602/     60A :                             opcode @r0, a
     603/     60A :                             inc r0
     604/     60A :                     
     605/     60A :                             ; xor bit 0 of the color value in r7 with ~carry
     606/     60A :                             cpl c
     607/     60A :                             clr a
     608/     60A :                             rlc a
     609/     60A :                             xrl a, r7
     610/     60A :                             ; write color value to the even byte
     611/     60A :                             opcode @r0, a
     612/     60A :                             inc r0
     613/     60A :                     
     614/     60A :                             ; increment to next byte
     615/     60A :                             inc r1
     616/     60A :                         endm
     617/     60A :                     
     618/     60A :                             ; r0 = vdc pointer
     619/     60A :                             ; r1 = extram lookup
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 20 - 01/22/2022 23:17:32


     620/     60A :                             ; r5 = -y/2 offset
     621/     60A :                             ; out r0 = r0 + 2
     622/     60A :                             ; out r1 = r1 + 1
     623/     60A :                             ; out r4 = (trashed)
     624/     60A :                             ; out r5 = r5
     625/     60A :                     compute_char_from_extram:
     626/     60A : (MACRO)                      compute_char_macro movx
     626/     60A :                             ; Load character byte (shifted left twice)
     626/     60A : 81                          movx a, @r1
     626/     60B :                             ; cut out the lower three bits
     626/     60B : 53 07                       anl a, #111b
     626/     60D :                             ; lookup in the color table and store temporarily in r7
     626/     60D : A3                          movp a, @a
     626/     60E : AF                          mov r7, a
     626/     60F :                     
     626/     60F :                             ; cut out the upper five bits
     626/     60F : 81                          movx a, @r1
     626/     610 : 53 F8                       anl a, #11111000b
     626/     612 :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     626/     612 : 6D                          add a, r5
     626/     613 :                             ; write char value to the odd byte
     626/     613 : 90                          MOVX @r0, a
     626/     614 : 18                          inc r0
     626/     615 :                     
     626/     615 :                             ; xor bit 0 of the color value in r7 with ~carry
     626/     615 : A7                          cpl c
     626/     616 : 27                          clr a
     626/     617 : F7                          rlc a
     626/     618 : DF                          xrl a, r7
     626/     619 :                             ; write color value to the even byte
     626/     619 : 90                          MOVX @r0, a
     626/     61A : 18                          inc r0
     626/     61B :                     
     626/     61B :                             ; increment to next byte
     626/     61B : 19                          inc r1
     627/     61C : 93                          retr
     628/     61D :                     
     629/     61D :                     compute_char_from_extram_mov:
     630/     61D : (MACRO)                      compute_char_macro mov
     630/     61D :                             ; Load character byte (shifted left twice)
     630/     61D : 81                          movx a, @r1
     630/     61E :                             ; cut out the lower three bits
     630/     61E : 53 07                       anl a, #111b
     630/     620 :                             ; lookup in the color table and store temporarily in r7
     630/     620 : A3                          movp a, @a
     630/     621 : AF                          mov r7, a
     630/     622 :                     
     630/     622 :                             ; cut out the upper five bits
     630/     622 : 81                          movx a, @r1
     630/     623 : 53 F8                       anl a, #11111000b
     630/     625 :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     630/     625 : 6D                          add a, r5
     630/     626 :                             ; write char value to the odd byte
     630/     626 : A0                          MOV @r0, a
     630/     627 : 18                          inc r0
     630/     628 :                     
     630/     628 :                             ; xor bit 0 of the color value in r7 with ~carry
     630/     628 : A7                          cpl c
     630/     629 : 27                          clr a
     630/     62A : F7                          rlc a
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 21 - 01/22/2022 23:17:32


     630/     62B : DF                          xrl a, r7
     630/     62C :                             ; write color value to the even byte
     630/     62C : A0                          MOV @r0, a
     630/     62D : 18                          inc r0
     630/     62E :                     
     630/     62E :                             ; increment to next byte
     630/     62E : 19                          inc r1
     631/     62F : 93                          retr
     632/     630 :                     
     633/     630 :                     compute_chars:
     634/     630 :                     
     635/     630 : (MACRO)                      inline_external_ram
     635/     630 : 89 BC                       orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
     635/     632 : 99 AF                       anl p1,#0afh                      ; clear : !ramen copyen
     636/     634 :                     
     637/     634 : B8 20                       mov r0, #iram_tile_compute_start
     638/     636 : B9 3A                       mov r1, #iram_iram_index
     639/     638 : F1                          mov a, @r1
     640/     639 : A9                          mov r1, a
     641/     63A :                     
     642/     63A :                             ; Compute the next ten characters and store in scratchpad RAM
     643/     63A :                             ; We unroll this loop to save 40 cycles doing call/retr
     644/     63A : (MACRO)                      compute_char_macro mov
     644/     63A :                             ; Load character byte (shifted left twice)
     644/     63A : 81                          movx a, @r1
     644/     63B :                             ; cut out the lower three bits
     644/     63B : 53 07                       anl a, #111b
     644/     63D :                             ; lookup in the color table and store temporarily in r7
     644/     63D : A3                          movp a, @a
     644/     63E : AF                          mov r7, a
     644/     63F :                     
     644/     63F :                             ; cut out the upper five bits
     644/     63F : 81                          movx a, @r1
     644/     640 : 53 F8                       anl a, #11111000b
     644/     642 :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     644/     642 : 6D                          add a, r5
     644/     643 :                             ; write char value to the odd byte
     644/     643 : A0                          MOV @r0, a
     644/     644 : 18                          inc r0
     644/     645 :                     
     644/     645 :                             ; xor bit 0 of the color value in r7 with ~carry
     644/     645 : A7                          cpl c
     644/     646 : 27                          clr a
     644/     647 : F7                          rlc a
     644/     648 : DF                          xrl a, r7
     644/     649 :                             ; write color value to the even byte
     644/     649 : A0                          MOV @r0, a
     644/     64A : 18                          inc r0
     644/     64B :                     
     644/     64B :                             ; increment to next byte
     644/     64B : 19                          inc r1
     645/     64C : (MACRO)                      compute_char_macro mov
     645/     64C :                             ; Load character byte (shifted left twice)
     645/     64C : 81                          movx a, @r1
     645/     64D :                             ; cut out the lower three bits
     645/     64D : 53 07                       anl a, #111b
     645/     64F :                             ; lookup in the color table and store temporarily in r7
     645/     64F : A3                          movp a, @a
     645/     650 : AF                          mov r7, a
     645/     651 :                     
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 22 - 01/22/2022 23:17:32


     645/     651 :                             ; cut out the upper five bits
     645/     651 : 81                          movx a, @r1
     645/     652 : 53 F8                       anl a, #11111000b
     645/     654 :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     645/     654 : 6D                          add a, r5
     645/     655 :                             ; write char value to the odd byte
     645/     655 : A0                          MOV @r0, a
     645/     656 : 18                          inc r0
     645/     657 :                     
     645/     657 :                             ; xor bit 0 of the color value in r7 with ~carry
     645/     657 : A7                          cpl c
     645/     658 : 27                          clr a
     645/     659 : F7                          rlc a
     645/     65A : DF                          xrl a, r7
     645/     65B :                             ; write color value to the even byte
     645/     65B : A0                          MOV @r0, a
     645/     65C : 18                          inc r0
     645/     65D :                     
     645/     65D :                             ; increment to next byte
     645/     65D : 19                          inc r1
     646/     65E : (MACRO)                      compute_char_macro mov
     646/     65E :                             ; Load character byte (shifted left twice)
     646/     65E : 81                          movx a, @r1
     646/     65F :                             ; cut out the lower three bits
     646/     65F : 53 07                       anl a, #111b
     646/     661 :                             ; lookup in the color table and store temporarily in r7
     646/     661 : A3                          movp a, @a
     646/     662 : AF                          mov r7, a
     646/     663 :                     
     646/     663 :                             ; cut out the upper five bits
     646/     663 : 81                          movx a, @r1
     646/     664 : 53 F8                       anl a, #11111000b
     646/     666 :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     646/     666 : 6D                          add a, r5
     646/     667 :                             ; write char value to the odd byte
     646/     667 : A0                          MOV @r0, a
     646/     668 : 18                          inc r0
     646/     669 :                     
     646/     669 :                             ; xor bit 0 of the color value in r7 with ~carry
     646/     669 : A7                          cpl c
     646/     66A : 27                          clr a
     646/     66B : F7                          rlc a
     646/     66C : DF                          xrl a, r7
     646/     66D :                             ; write color value to the even byte
     646/     66D : A0                          MOV @r0, a
     646/     66E : 18                          inc r0
     646/     66F :                     
     646/     66F :                             ; increment to next byte
     646/     66F : 19                          inc r1
     647/     670 : (MACRO)                      compute_char_macro mov
     647/     670 :                             ; Load character byte (shifted left twice)
     647/     670 : 81                          movx a, @r1
     647/     671 :                             ; cut out the lower three bits
     647/     671 : 53 07                       anl a, #111b
     647/     673 :                             ; lookup in the color table and store temporarily in r7
     647/     673 : A3                          movp a, @a
     647/     674 : AF                          mov r7, a
     647/     675 :                     
     647/     675 :                             ; cut out the upper five bits
     647/     675 : 81                          movx a, @r1
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 23 - 01/22/2022 23:17:32


     647/     676 : 53 F8                       anl a, #11111000b
     647/     678 :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     647/     678 : 6D                          add a, r5
     647/     679 :                             ; write char value to the odd byte
     647/     679 : A0                          MOV @r0, a
     647/     67A : 18                          inc r0
     647/     67B :                     
     647/     67B :                             ; xor bit 0 of the color value in r7 with ~carry
     647/     67B : A7                          cpl c
     647/     67C : 27                          clr a
     647/     67D : F7                          rlc a
     647/     67E : DF                          xrl a, r7
     647/     67F :                             ; write color value to the even byte
     647/     67F : A0                          MOV @r0, a
     647/     680 : 18                          inc r0
     647/     681 :                     
     647/     681 :                             ; increment to next byte
     647/     681 : 19                          inc r1
     648/     682 : (MACRO)                      compute_char_macro mov
     648/     682 :                             ; Load character byte (shifted left twice)
     648/     682 : 81                          movx a, @r1
     648/     683 :                             ; cut out the lower three bits
     648/     683 : 53 07                       anl a, #111b
     648/     685 :                             ; lookup in the color table and store temporarily in r7
     648/     685 : A3                          movp a, @a
     648/     686 : AF                          mov r7, a
     648/     687 :                     
     648/     687 :                             ; cut out the upper five bits
     648/     687 : 81                          movx a, @r1
     648/     688 : 53 F8                       anl a, #11111000b
     648/     68A :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     648/     68A : 6D                          add a, r5
     648/     68B :                             ; write char value to the odd byte
     648/     68B : A0                          MOV @r0, a
     648/     68C : 18                          inc r0
     648/     68D :                     
     648/     68D :                             ; xor bit 0 of the color value in r7 with ~carry
     648/     68D : A7                          cpl c
     648/     68E : 27                          clr a
     648/     68F : F7                          rlc a
     648/     690 : DF                          xrl a, r7
     648/     691 :                             ; write color value to the even byte
     648/     691 : A0                          MOV @r0, a
     648/     692 : 18                          inc r0
     648/     693 :                     
     648/     693 :                             ; increment to next byte
     648/     693 : 19                          inc r1
     649/     694 : (MACRO)                      compute_char_macro mov
     649/     694 :                             ; Load character byte (shifted left twice)
     649/     694 : 81                          movx a, @r1
     649/     695 :                             ; cut out the lower three bits
     649/     695 : 53 07                       anl a, #111b
     649/     697 :                             ; lookup in the color table and store temporarily in r7
     649/     697 : A3                          movp a, @a
     649/     698 : AF                          mov r7, a
     649/     699 :                     
     649/     699 :                             ; cut out the upper five bits
     649/     699 : 81                          movx a, @r1
     649/     69A : 53 F8                       anl a, #11111000b
     649/     69C :                             ; add to the "-Y/2 offset" and hold onto carry outcome
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 24 - 01/22/2022 23:17:32


     649/     69C : 6D                          add a, r5
     649/     69D :                             ; write char value to the odd byte
     649/     69D : A0                          MOV @r0, a
     649/     69E : 18                          inc r0
     649/     69F :                     
     649/     69F :                             ; xor bit 0 of the color value in r7 with ~carry
     649/     69F : A7                          cpl c
     649/     6A0 : 27                          clr a
     649/     6A1 : F7                          rlc a
     649/     6A2 : DF                          xrl a, r7
     649/     6A3 :                             ; write color value to the even byte
     649/     6A3 : A0                          MOV @r0, a
     649/     6A4 : 18                          inc r0
     649/     6A5 :                     
     649/     6A5 :                             ; increment to next byte
     649/     6A5 : 19                          inc r1
     650/     6A6 : (MACRO)                      compute_char_macro mov
     650/     6A6 :                             ; Load character byte (shifted left twice)
     650/     6A6 : 81                          movx a, @r1
     650/     6A7 :                             ; cut out the lower three bits
     650/     6A7 : 53 07                       anl a, #111b
     650/     6A9 :                             ; lookup in the color table and store temporarily in r7
     650/     6A9 : A3                          movp a, @a
     650/     6AA : AF                          mov r7, a
     650/     6AB :                     
     650/     6AB :                             ; cut out the upper five bits
     650/     6AB : 81                          movx a, @r1
     650/     6AC : 53 F8                       anl a, #11111000b
     650/     6AE :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     650/     6AE : 6D                          add a, r5
     650/     6AF :                             ; write char value to the odd byte
     650/     6AF : A0                          MOV @r0, a
     650/     6B0 : 18                          inc r0
     650/     6B1 :                     
     650/     6B1 :                             ; xor bit 0 of the color value in r7 with ~carry
     650/     6B1 : A7                          cpl c
     650/     6B2 : 27                          clr a
     650/     6B3 : F7                          rlc a
     650/     6B4 : DF                          xrl a, r7
     650/     6B5 :                             ; write color value to the even byte
     650/     6B5 : A0                          MOV @r0, a
     650/     6B6 : 18                          inc r0
     650/     6B7 :                     
     650/     6B7 :                             ; increment to next byte
     650/     6B7 : 19                          inc r1
     651/     6B8 : (MACRO)                      compute_char_macro mov
     651/     6B8 :                             ; Load character byte (shifted left twice)
     651/     6B8 : 81                          movx a, @r1
     651/     6B9 :                             ; cut out the lower three bits
     651/     6B9 : 53 07                       anl a, #111b
     651/     6BB :                             ; lookup in the color table and store temporarily in r7
     651/     6BB : A3                          movp a, @a
     651/     6BC : AF                          mov r7, a
     651/     6BD :                     
     651/     6BD :                             ; cut out the upper five bits
     651/     6BD : 81                          movx a, @r1
     651/     6BE : 53 F8                       anl a, #11111000b
     651/     6C0 :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     651/     6C0 : 6D                          add a, r5
     651/     6C1 :                             ; write char value to the odd byte
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 25 - 01/22/2022 23:17:32


     651/     6C1 : A0                          MOV @r0, a
     651/     6C2 : 18                          inc r0
     651/     6C3 :                     
     651/     6C3 :                             ; xor bit 0 of the color value in r7 with ~carry
     651/     6C3 : A7                          cpl c
     651/     6C4 : 27                          clr a
     651/     6C5 : F7                          rlc a
     651/     6C6 : DF                          xrl a, r7
     651/     6C7 :                             ; write color value to the even byte
     651/     6C7 : A0                          MOV @r0, a
     651/     6C8 : 18                          inc r0
     651/     6C9 :                     
     651/     6C9 :                             ; increment to next byte
     651/     6C9 : 19                          inc r1
     652/     6CA : (MACRO)                      compute_char_macro mov
     652/     6CA :                             ; Load character byte (shifted left twice)
     652/     6CA : 81                          movx a, @r1
     652/     6CB :                             ; cut out the lower three bits
     652/     6CB : 53 07                       anl a, #111b
     652/     6CD :                             ; lookup in the color table and store temporarily in r7
     652/     6CD : A3                          movp a, @a
     652/     6CE : AF                          mov r7, a
     652/     6CF :                     
     652/     6CF :                             ; cut out the upper five bits
     652/     6CF : 81                          movx a, @r1
     652/     6D0 : 53 F8                       anl a, #11111000b
     652/     6D2 :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     652/     6D2 : 6D                          add a, r5
     652/     6D3 :                             ; write char value to the odd byte
     652/     6D3 : A0                          MOV @r0, a
     652/     6D4 : 18                          inc r0
     652/     6D5 :                     
     652/     6D5 :                             ; xor bit 0 of the color value in r7 with ~carry
     652/     6D5 : A7                          cpl c
     652/     6D6 : 27                          clr a
     652/     6D7 : F7                          rlc a
     652/     6D8 : DF                          xrl a, r7
     652/     6D9 :                             ; write color value to the even byte
     652/     6D9 : A0                          MOV @r0, a
     652/     6DA : 18                          inc r0
     652/     6DB :                     
     652/     6DB :                             ; increment to next byte
     652/     6DB : 19                          inc r1
     653/     6DC :                             ; for the last precompute, we skip the 10th character that gets written via a char move (r3/r4)
     654/     6DC : 19                          inc r1
     655/     6DD : (MACRO)                      compute_char_macro mov
     655/     6DD :                             ; Load character byte (shifted left twice)
     655/     6DD : 81                          movx a, @r1
     655/     6DE :                             ; cut out the lower three bits
     655/     6DE : 53 07                       anl a, #111b
     655/     6E0 :                             ; lookup in the color table and store temporarily in r7
     655/     6E0 : A3                          movp a, @a
     655/     6E1 : AF                          mov r7, a
     655/     6E2 :                     
     655/     6E2 :                             ; cut out the upper five bits
     655/     6E2 : 81                          movx a, @r1
     655/     6E3 : 53 F8                       anl a, #11111000b
     655/     6E5 :                             ; add to the "-Y/2 offset" and hold onto carry outcome
     655/     6E5 : 6D                          add a, r5
     655/     6E6 :                             ; write char value to the odd byte
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 26 - 01/22/2022 23:17:32


     655/     6E6 : A0                          MOV @r0, a
     655/     6E7 : 18                          inc r0
     655/     6E8 :                     
     655/     6E8 :                             ; xor bit 0 of the color value in r7 with ~carry
     655/     6E8 : A7                          cpl c
     655/     6E9 : 27                          clr a
     655/     6EA : F7                          rlc a
     655/     6EB : DF                          xrl a, r7
     655/     6EC :                             ; write color value to the even byte
     655/     6EC : A0                          MOV @r0, a
     655/     6ED : 18                          inc r0
     655/     6EE :                     
     655/     6EE :                             ; increment to next byte
     655/     6EE : 19                          inc r1
     656/     6EF : 19                          inc r1
     657/     6F0 :                     
     658/     6F0 :                             ; HACK
     659/     6F0 :                             ; inc r1
     660/     6F0 :                     
     661/     6F0 : (MACRO)                      assert "hi(compute_page) == hi($)"
     661/     6F0 : =>FALSE                      if (~~val("hi(compute_page) == hi($)"))
     661/     6F0 :                                 error "hi(compute_page) == hi($)"
     661/     6F0 : [661]                        endif
     662/     6F0 :                     
     663/     6F0 :                             ; Compute space/empty character
     664/     6F0 : =>UNDEFINED              ifdef DEBUG_COLORS
     665/     6F0 :                             mov a, #lo(47 << 3) + 1
     666/     6F0 : =>TRUE                   else
     667/     6F0 : 23 61                       mov a, #lo(' ' << 3) + 1
     668/     6F2 : [664]                    endif
     669/     6F2 : 6D                          add a, r5
     670/     6F3 : 07                          dec a
     671/     6F4 : AA                          mov r2, a
     672/     6F5 :                     
     673/     6F5 :                             ; save iram_iram_index
     674/     6F5 : F9                          mov a, r1
     675/     6F6 : B9 3A                       mov r1, #iram_iram_index
     676/     6F8 : A1                          mov @r1, a
     677/     6F9 :                     
     678/     6F9 : (MACRO)                      inline_external_vdc
     678/     6F9 : 89 BC                       orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
     678/     6FB : 99 B7                       anl p1,#0b7h                      ; clear : !vdcen copyen (?)
     679/     6FD :                     
     680/     6FD :                     
     681/     6FD :                     ;----------------------
     682/     6FD :                     ; Row loop + write to VDC during critical period
     683/     6FD :                     ;----------------------
     684/     6FD :                     
     685/     6FD :                             ; Timing-sensitive "inner loop" that writes to VDC before each row
     686/     6FD :                             ; uses r0, r1, r2, r5, r6
     687/     6FD :                     row_write_to_vdc:
     688/     6FD :                             ; increment r5 (Y offset for VDC)
     689/     6FD : FD                          mov a, r5
     690/     6FE : 03 F6                       add a, #(-10)
     691/     700 : AD                          mov r5, a
     692/     701 :                             ; increment r6 (Y position for quads)
     693/     701 : FE                          mov a, r6
     694/     702 : 03 14                       add a, #20
     695/     704 : AE                          mov r6, a
     696/     705 :                     
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 27 - 01/22/2022 23:17:32


     697/     705 :                             ; Base of scratchpad RAM
     698/     705 : B9 20                       mov r1, #iram_tile_compute_start
     699/     707 :                     
     700/     707 :                         .critical_zone:
     701/     707 :                             ; Disable foreground graphics
     702/     707 : (MACRO)                      disable_vdc_foreground
     702/     707 : B8 A0                       mov r0, #0a0h
     702/     709 : 23 88                       mov a,#8|128
     702/     70B : 90                          movx @r0,a
     703/     70C :                     
     704/     70C :                             ; Move all quads down
     705/     70C : FE                          mov a, r6
     706/     70D : B8 40                       mov r0, #vdc_quad0
     707/     70F : 90                          movx @r0,a
     708/     710 : B8 50                       mov r0, #vdc_quad1
     709/     712 : 90                          movx @r0,a
     710/     713 : B8 60                       mov r0, #vdc_quad2
     711/     715 : 90                          movx @r0,a
     712/     716 :                             ; mov r0, #vdc_quad3
     713/     716 :                             ; movx @r0,a
     714/     716 :                     
     715/     716 :                             ; Copy from scratchpad RAM into VDC registers (10 cycles)
     716/     716 :                     write_to_char macro dest
     717/     716 :                             mov a, @r1
     718/     716 :                             inc r1
     719/     716 :                             mov r0, #dest+2
     720/     716 :                             movx @r0,a
     721/     716 :                             mov a, @r1
     722/     716 :                             inc r1
     723/     716 :                             inc r0
     724/     716 :                             movx @r0,a
     725/     716 :                         endm
     726/     716 :                     
     727/     716 :                             ; Repeat for each quad; to do this quickly we unroll the loop and repeat for each quad write
     728/     716 :                             ; We also do this in visual order, not memory order
     729/     716 : (MACRO)                      write_to_char vdc_quad0+0
     729/     716 : F1                          mov a, @r1
     729/     717 : 19                          inc r1
     729/     718 : B8 42                       mov r0, #VDC_QUAD0+0+2
     729/     71A : 90                          movx @r0,a
     729/     71B : F1                          mov a, @r1
     729/     71C : 19                          inc r1
     729/     71D : 18                          inc r0
     729/     71E : 90                          movx @r0,a
     730/     71F : (MACRO)                      write_to_char vdc_quad1+0
     730/     71F : F1                          mov a, @r1
     730/     720 : 19                          inc r1
     730/     721 : B8 52                       mov r0, #VDC_QUAD1+0+2
     730/     723 : 90                          movx @r0,a
     730/     724 : F1                          mov a, @r1
     730/     725 : 19                          inc r1
     730/     726 : 18                          inc r0
     730/     727 : 90                          movx @r0,a
     731/     728 : (MACRO)                      write_to_char vdc_quad0+4
     731/     728 : F1                          mov a, @r1
     731/     729 : 19                          inc r1
     731/     72A : B8 46                       mov r0, #VDC_QUAD0+4+2
     731/     72C : 90                          movx @r0,a
     731/     72D : F1                          mov a, @r1
     731/     72E : 19                          inc r1
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 28 - 01/22/2022 23:17:32


     731/     72F : 18                          inc r0
     731/     730 : 90                          movx @r0,a
     732/     731 : (MACRO)                      write_to_char vdc_quad1+4
     732/     731 : F1                          mov a, @r1
     732/     732 : 19                          inc r1
     732/     733 : B8 56                       mov r0, #VDC_QUAD1+4+2
     732/     735 : 90                          movx @r0,a
     732/     736 : F1                          mov a, @r1
     732/     737 : 19                          inc r1
     732/     738 : 18                          inc r0
     732/     739 : 90                          movx @r0,a
     733/     73A : (MACRO)                      write_to_char vdc_quad0+8
     733/     73A : F1                          mov a, @r1
     733/     73B : 19                          inc r1
     733/     73C : B8 4A                       mov r0, #VDC_QUAD0+8+2
     733/     73E : 90                          movx @r0,a
     733/     73F : F1                          mov a, @r1
     733/     740 : 19                          inc r1
     733/     741 : 18                          inc r0
     733/     742 : 90                          movx @r0,a
     734/     743 : (MACRO)                      write_to_char vdc_quad1+8
     734/     743 : F1                          mov a, @r1
     734/     744 : 19                          inc r1
     734/     745 : B8 5A                       mov r0, #VDC_QUAD1+8+2
     734/     747 : 90                          movx @r0,a
     734/     748 : F1                          mov a, @r1
     734/     749 : 19                          inc r1
     734/     74A : 18                          inc r0
     734/     74B : 90                          movx @r0,a
     735/     74C : (MACRO)                      write_to_char vdc_quad0+12
     735/     74C : F1                          mov a, @r1
     735/     74D : 19                          inc r1
     735/     74E : B8 4E                       mov r0, #VDC_QUAD0+12+2
     735/     750 : 90                          movx @r0,a
     735/     751 : F1                          mov a, @r1
     735/     752 : 19                          inc r1
     735/     753 : 18                          inc r0
     735/     754 : 90                          movx @r0,a
     736/     755 : (MACRO)                      write_to_char vdc_quad1+12
     736/     755 : F1                          mov a, @r1
     736/     756 : 19                          inc r1
     736/     757 : B8 5E                       mov r0, #VDC_QUAD1+12+2
     736/     759 : 90                          movx @r0,a
     736/     75A : F1                          mov a, @r1
     736/     75B : 19                          inc r1
     736/     75C : 18                          inc r0
     736/     75D : 90                          movx @r0,a
     737/     75E : (MACRO)                      write_to_char vdc_quad2+0
     737/     75E : F1                          mov a, @r1
     737/     75F : 19                          inc r1
     737/     760 : B8 62                       mov r0, #VDC_QUAD2+0+2
     737/     762 : 90                          movx @r0,a
     737/     763 : F1                          mov a, @r1
     737/     764 : 19                          inc r1
     737/     765 : 18                          inc r0
     737/     766 : 90                          movx @r0,a
     738/     767 :                     
     739/     767 :                             ; Can elide the last "inc r1" for the last quad
     740/     767 : F1                          mov a, @r1
     741/     768 : 19                          inc r1
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 29 - 01/22/2022 23:17:32


     742/     769 : B8 66                       mov r0, #vdc_quad2+4+2
     743/     76B : 90                          movx @r0,a
     744/     76C :                     
     745/     76C :                             ; HACK for 13 wide row
     746/     76C : B8 6A                       mov r0, #vdc_quad2+8+2     ; 2
     747/     76E : 90                          movx @r0, a
     748/     76F :                     
     749/     76F : F1                          mov a, @r1
     750/     770 :                             ; inc r1
     751/     770 : 18                          inc r0
     752/     771 : 90                          movx @r0,a
     753/     772 :                     
     754/     772 :                             ; Write out "empty" characters (last two entries in the third quad) using r2
     755/     772 : FA                          mov a, r2
     756/     773 : B8 6E                       mov r0, #vdc_quad2+12+2     ; 2
     757/     775 : 90                          movx @r0, a
     758/     776 :                     
     759/     776 :                             ; Rewrite the last row
     760/     776 : FB                          mov a, r3
     761/     777 : A8                          mov r0, a
     762/     778 : FC                          mov a, r4
     763/     779 : 90                          movx @r0, a
     764/     77A :                     
     765/     77A :                             ; HACK for 13 wide row
     766/     77A : 19                          inc r1
     767/     77B : 19                          inc r1
     768/     77C :                     
     769/     77C :                             ; Pad out the rest of the cycles in the line
     770/     77C :                             ; TODO: this can be reused for something more interesting graphically
     771/     77C : (MACRO)                      sleep_loop r0, TIMING_VDC_WRITE_PADDING
     771/     77C : =>TRUE                   if TIMING_VDC_WRITE_PADDING < 5
     771/     77C :  (MACRO-2)                   sleep_nop TIMING_VDC_WRITE_PADDING
     771/     77C :                         rept TIMING_VDC_WRITE_PADDING
     771/     77C :                             nop
     771/     77C :                         endm
     771/     77C : 00                          nop
     771/     77D : 00                          nop
     771/     77E : =>FALSE                  else
     771/     77E :                             if ((TIMING_VDC_WRITE_PADDING - 2) # 2) == 1
     771/     77E :                                 nop
     771/     77E : [771]                        endif
     771/     77E :                                 mov R0,#((TIMING_VDC_WRITE_PADDING - 2) / 2)
     771/     77E :                             -:
     771/     77E :                                 djnz R0,-
     771/     77E : [771]                    endif
     772/     77E :                     
     773/     77E :                             ; Enable foreground graphics
     774/     77E : (MACRO)                      enable_vdc_foreground
     774/     77E : B8 A0                       mov r0, #0a0h
     774/     780 : 23 A8                       mov a,#8|32|128
     774/     782 : 90                          movx @r0,a
     775/     783 :                     
     776/     783 :                         .sleep_until_next_row:
     777/     783 :                             ; wait loop until next row
     778/     783 : (MACRO)                      sleep_loop r0, TIMING_AFTER_COMPUTE
     778/     783 : =>FALSE                  if TIMING_AFTER_COMPUTE < 5
     778/     783 :                             sleep_nop TIMING_AFTER_COMPUTE
     778/     783 : =>TRUE                   else
     778/     783 : =>TRUE                       if ((TIMING_AFTER_COMPUTE - 2) # 2) == 1
     778/     783 : 00                              nop
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 30 - 01/22/2022 23:17:32


     778/     784 : [778]                        endif
     778/     784 : B8 13                           mov R0,#((TIMING_AFTER_COMPUTE - 2) / 2)
     778/     786 :                             -:
     778/     786 : E8 86                           djnz R0,-
     778/     788 : [778]                    endif
     779/     788 :                     
     780/     788 :                             ; set grid+background color
     781/     788 : =>UNDEFINED              ifdef DEBUG_COLORS
     782/     788 :                             mov	r0,#vdc_color
     783/     788 :                             mov r1,#iram_iram_index
     784/     788 :                             mov	a,@r1
     785/     788 :                             movx	@r0,a
     786/     788 : =>TRUE                   else
     787/     788 : (MACRO)                      sleep_loop r0, 7
     787/     788 : =>FALSE                  if 7 < 5
     787/     788 :                             sleep_nop 7
     787/     788 : =>TRUE                   else
     787/     788 : =>TRUE                       if ((7 - 2) # 2) == 1
     787/     788 : 00                              nop
     787/     789 : [787]                        endif
     787/     789 : B8 02                           mov R0,#((7 - 2) / 2)
     787/     78B :                             -:
     787/     78B : E8 8B                           djnz R0,-
     787/     78D : [787]                    endif
     788/     78D : [781]                    endif
     789/     78D :                     
     790/     78D :                             ; VDC is enabled, start computing next row
     791/     78D : 93                          retr
     792/     78E :                     
     793/     78E :                     
     794/     78E :                     ;------------------------------
     795/     78E :                     ; Program loop, starts in bank 1
     796/     78E :                     ;------------------------------
     797/     78E :                     
     798/     78E : =6AH                 EXTRAM_SCORE            equ 0x6a
     799/     78E :                     ; EXTRAM_APPLE_X          equ 0x62
     800/     78E :                     ; EXTRAM_APPLE_Y          equ 0x63
     801/     78E : =6BH                 EXTRAM_SNAKE_START_X    equ 0x6b
     802/     78E : =6CH                 EXTRAM_SNAKE_START_Y    equ 0x6c
     803/     78E : =6DH                 EXTRAM_SNAKE_START_DIR  equ 0x6d
     804/     78E : =6EH                 EXTRAM_SNAKE_END_X      equ 0x6e
     805/     78E : =6FH                 EXTRAM_SNAKE_END_Y      equ 0x6f
     806/     78E : =70H                 EXTRAM_SNAKE_END_DIR    equ 0x70
     807/     78E : =71H                 EXTRAM_FRAME            equ 0x71
     808/     78E :                     ; EXTRAM_RANDOM           equ 0x6b
     809/     78E :                     
     810/     78E : =3AH                 SNAKE_TILE              equ 58
     811/     78E : =34H                 SNAKE_LEFT              equ 52
     812/     78E : =33H                 SNAKE_RIGHT             equ 51
     813/     78E : =31H                 APPLE_TILE              equ 49
     814/     78E : =' '                 EMPTY_TILE              equ ' '
     815/     78E :                     
     816/     78E :                     ; Same as joystick bit pattern
     817/     78E : =1H                  DIR_UP                  equ 1 << 0
     818/     78E : =2H                  DIR_RIGHT               equ 1 << 1
     819/     78E : =4H                  DIR_DOWN                equ 1 << 2
     820/     78E : =8H                  DIR_LEFT                equ 1 << 3
     821/     78E :                     
     822/     800 :                             org $800
     823/     800 :                     
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 31 - 01/22/2022 23:17:32


     824/     800 :                             ; main loop
     825/     800 :                     main:
     826/     800 : 15                          dis i
     827/     801 : (MACRO)                      inline_external_vdc
     827/     801 : 89 BC                       orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
     827/     803 : 99 B7                       anl p1,#0b7h                      ; clear : !vdcen copyen (?)
     828/     805 :                     
     829/     805 : 23 46                       mov a, #70
     830/     807 : B8 00                       mov r0, #vdc_spr0_ctrl
     831/     809 : 90                          movx @r0, a  ;y
     832/     80A : 18                          inc r0
     833/     80B : 23 20                       mov a, #32
     834/     80D : 90                          movx @r0, a ;x
     835/     80E : 18                          inc r0
     836/     80F : 23 20                       mov a, #col_spr_blue
     837/     811 : 90                          movx @r0, a ;col
     838/     812 :                     
     839/     812 : 23 AA                       mov a, #10101010b
     840/     814 : B8 80                       mov r0, #vdc_spr0_shape
     841/     816 : 90                          movx @r0, a
     842/     817 : B9 08                       mov r1, #8
     843/     819 :                         -:
     844/     819 : 18                          inc r0
     845/     81A : E7                          rl a
     846/     81B : 90                          movx @r0, a
     847/     81C : E9 19                       djnz r1, -
     848/     81E :                             
     849/     81E :                     
     850/     81E : (MACRO)                      inline_external_ram
     850/     81E : 89 BC                       orl p1,#0bch                      ; set : !kbscan !vdcen !ramen  lumen
     850/     820 : 99 AF                       anl p1,#0afh                      ; clear : !ramen copyen
     851/     822 : 05                          en i
     852/     823 :                     
     853/     823 :                             ; random byte
     854/     823 : 23 04                       mov a, #4
     855/     825 : B8 3D                       mov r0, #iram_random
     856/     827 : A0                          mov @r0, a
     857/     828 :                     
     858/     828 :                             ; Write decorative tiles
     859/     828 : (MACRO)                      write_extram_string 'SNAKE', 2, 0, TILE_GREEN
     859/     828 : B8 02                       mov r0, #2 + (0 * 12)
     859/     82A : =0H                  .cnt set 0
     859/     82A :                             while .cnt < STRLEN('SNAKE')
     859/     82A :                                 mov a, #rotln(lo(SUBSTR('SNAKE', .cnt, 1) << 2) | TILE_GREEN, 8, 1)
     859/     82A :                                 movx @r0, a
     859/     82A :                                 inc r0
     859/     82A :                     .cnt set .cnt + 1
     859/     82A :                             endm
     859/     82A : 23 CC                           mov a, #rotln(lo(SUBSTR('SNAKE', .cnt, 1) << 2) | TILE_GREEN, 8, 1)
     859/     82C : 90                              movx @r0, a
     859/     82D : 18                              inc r0
     859/     82E : =1H                  .cnt set .cnt + 1
     859/     82E : 23 6D                           mov a, #rotln(lo(SUBSTR('SNAKE', .cnt, 1) << 2) | TILE_GREEN, 8, 1)
     859/     830 : 90                              movx @r0, a
     859/     831 : 18                              inc r0
     859/     832 : =2H                  .cnt set .cnt + 1
     859/     832 : 23 05                           mov a, #rotln(lo(SUBSTR('SNAKE', .cnt, 1) << 2) | TILE_GREEN, 8, 1)
     859/     834 : 90                              movx @r0, a
     859/     835 : 18                              inc r0
     859/     836 : =3H                  .cnt set .cnt + 1
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 32 - 01/22/2022 23:17:32


     859/     836 : 23 FC                           mov a, #rotln(lo(SUBSTR('SNAKE', .cnt, 1) << 2) | TILE_GREEN, 8, 1)
     859/     838 : 90                              movx @r0, a
     859/     839 : 18                              inc r0
     859/     83A : =4H                  .cnt set .cnt + 1
     859/     83A : 23 94                           mov a, #rotln(lo(SUBSTR('SNAKE', .cnt, 1) << 2) | TILE_GREEN, 8, 1)
     859/     83C : 90                              movx @r0, a
     859/     83D : 18                              inc r0
     859/     83E : =5H                  .cnt set .cnt + 1
     859/     83E :                     
     860/     83E : (MACRO)                      write_extram_char 54, 7, 0, TILE_BLUE
     860/     83E : 23 B7                       mov a, #rotln((54 << 2) | TILE_BLUE, 8, 1)
     860/     840 : B8 07                       mov r0, #7 + (0 * 12)
     860/     842 : 90                          movx @r0, a
     861/     843 : (MACRO)                      write_extram_string '00', 8, 0, TILE_WHITE
     861/     843 : B8 08                       mov r0, #8 + (0 * 12)
     861/     845 : =0H                  .cnt set 0
     861/     845 :                             while .cnt < STRLEN('00')
     861/     845 :                                 mov a, #rotln(lo(SUBSTR('00', .cnt, 1) << 2) | TILE_WHITE, 8, 1)
     861/     845 :                                 movx @r0, a
     861/     845 :                                 inc r0
     861/     845 :                     .cnt set .cnt + 1
     861/     845 :                             endm
     861/     845 : 23 00                           mov a, #rotln(lo(SUBSTR('00', .cnt, 1) << 2) | TILE_WHITE, 8, 1)
     861/     847 : 90                              movx @r0, a
     861/     848 : 18                              inc r0
     861/     849 : =1H                  .cnt set .cnt + 1
     861/     849 : 23 00                           mov a, #rotln(lo(SUBSTR('00', .cnt, 1) << 2) | TILE_WHITE, 8, 1)
     861/     84B : 90                              movx @r0, a
     861/     84C : 18                              inc r0
     861/     84D : =2H                  .cnt set .cnt + 1
     861/     84D :                     
     862/     84D :                     
     863/     84D :                             ; extram frame
     864/     84D : 23 00                       mov a, #0
     865/     84F : B8 71                       mov r0, #EXTRAM_FRAME
     866/     851 : 90                          movx @r0, a
     867/     852 :                             ; extram score
     868/     852 : 27                          clr a
     869/     853 : B8 6A                       mov r0, #EXTRAM_SCORE
     870/     855 : 90                          movx @r0, a
     871/     856 :                     
     872/     856 :                             ; extram snake start x
     873/     856 : 23 03                       mov a, #3
     874/     858 : B8 6B                       mov r0, #EXTRAM_SNAKE_START_X
     875/     85A : 90                          movx @r0, a
     876/     85B :                             ; extram snake start y
     877/     85B : 23 04                       mov a, #4
     878/     85D : B8 6C                       mov r0, #EXTRAM_SNAKE_START_Y
     879/     85F : 90                          movx @r0, a
     880/     860 :                             ; extram snake start dir
     881/     860 : 23 02                       mov a, #DIR_RIGHT
     882/     862 : B8 6D                       mov r0, #EXTRAM_SNAKE_START_DIR
     883/     864 : 90                          movx @r0, a
     884/     865 :                             ; extram snake end x
     885/     865 : 23 04                       mov a, #4
     886/     867 : B8 6E                       mov r0, #EXTRAM_SNAKE_END_X
     887/     869 : 90                          movx @r0, a
     888/     86A :                             ; extram snake end y
     889/     86A : 23 04                       mov a, #4
     890/     86C : B8 6F                       mov r0, #EXTRAM_SNAKE_END_Y
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 33 - 01/22/2022 23:17:32


     891/     86E : 90                          movx @r0, a
     892/     86F :                             ; extram snake end dir
     893/     86F : 23 02                       mov a, #DIR_RIGHT
     894/     871 : B8 70                       mov r0, #EXTRAM_SNAKE_END_DIR
     895/     873 : 90                          movx @r0, a
     896/     874 :                     
     897/     874 :                             ; draw snake
     898/     874 : B9 D5                       mov r1, #calc_extram_char(SNAKE_TILE, TILE_GREEN)
     899/     876 : BA 03                       mov r2, #3
     900/     878 : BB 04                       mov r3, #4
     901/     87A : 54 CB                       call routine_write_extram_char
     902/     87C : BA 04                       mov r2, #4
     903/     87E : BB 04                       mov r3, #4
     904/     880 : 54 CB                       call routine_write_extram_char
     905/     882 :                     
     906/     882 :                             ; TEMP snake extension
     907/     882 :                             ; mov r1, #calc_extram_char(SNAKE_RIGHT, TILE_GREEN)
     908/     882 :                             ; mov r2, #3
     909/     882 :                             ; mov r3, #4
     910/     882 :                             ; call routine_write_extram_char
     911/     882 :                             ; mov r1, #calc_extram_char(SNAKE_LEFT, TILE_GREEN)
     912/     882 :                             ; mov r2, #3
     913/     882 :                             ; mov r3, #5
     914/     882 :                             ; call routine_write_extram_char
     915/     882 :                             ; mov r1, #calc_extram_char(SNAKE_TILE, TILE_GREEN)
     916/     882 :                             ; mov r2, #2
     917/     882 :                             ; mov r3, #5
     918/     882 :                             ; call routine_write_extram_char
     919/     882 :                     
     920/     882 : 54 8C                       call new_apple_position
     921/     884 :                     
     922/     884 :                             ; en i
     923/     884 :                     
     924/     884 :                     main_loop:
     925/     884 :                             ; Clear the "frame done" flag
     926/     884 : B8 3C                       mov r0, #iram_ictrl
     927/     886 : F0                          mov a, @r0
     928/     887 : 53 7F                       anl a, #01111111b
     929/     889 : A0                          mov @r0, a
     930/     88A :                         
     931/     88A :                         .main_loop_start:
     932/     88A :                             ; Seed the randomizer with keyboard inputs
     933/     88A : B8 3B                       mov r0, #iram_keyboard
     934/     88C : F0                          mov a, @r0
     935/     88D : 53 0F                       anl a, #1111b
     936/     88F : C6 98                       jz +
     937/     891 : B8 3D                       mov r0, #iram_random
     938/     893 : F0                          mov a, @r0
     939/     894 : 77                          rr a
     940/     895 : 47                          swap a
     941/     896 : 77                          rr a
     942/     897 : A0                          mov @r0, a
     943/     898 :                         +:
     944/     898 :                             
     945/     898 :                             ; until a frame has passed, do nothing
     946/     898 : B8 3C                       mov r0, #iram_ictrl
     947/     89A : F0                          mov a, @r0
     948/     89B : 37                          cpl	a
     949/     89C : F2 8A                       jb7	.main_loop_start
     950/     89E :                     
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 34 - 01/22/2022 23:17:32


     951/     89E :                             ; bump frame
     952/     89E : B8 71                       mov r0, #EXTRAM_FRAME
     953/     8A0 : 80                          movx a, @r0
     954/     8A1 : 72 A7                       jb3 .next_frame
     955/     8A3 :                             ; jb4 .next_frame
     956/     8A3 :                             ; jb5 .next_frame
     957/     8A3 : 17                          inc a
     958/     8A4 : 90                          movx @r0, a
     959/     8A5 : 04 84                       jmp main_loop
     960/     8A7 :                         .next_frame:
     961/     8A7 :                             ; Clear frameskip number
     962/     8A7 : 23 00                       mov a, #0
     963/     8A9 : 90                          movx @r0, a
     964/     8AA :                     
     965/     8AA : 24 00                       jmp change_direction
     966/     8AC :                     
     967/     8AC :                     
     968/     8AC :                     
     969/     8AC :                             align 128
     970/     900 :                     
     971/     900 :                     change_direction:
     972/     900 :                             ; Move current direction into r4
     973/     900 : B8 70                       mov r0, #EXTRAM_SNAKE_END_DIR
     974/     902 : 80                          movx a, @r0
     975/     903 : AC                          mov r4, a
     976/     904 :                     
     977/     904 :                             ; load joystick ram
     978/     904 : B8 3B                       mov r0, #iram_keyboard
     979/     906 : F0                          mov a, @r0
     980/     907 :                             ; clear joystick
     981/     907 : AD                          mov r5, a
     982/     908 : 27                          clr a
     983/     909 : A0                          mov @r0, a
     984/     90A : FD                          mov a, r5
     985/     90B :                     
     986/     90B : 12 15                       jb0 .up
     987/     90D : 32 29                       jb1 .right
     988/     90F : 52 3D                       jb2 .down
     989/     911 : 72 51                       jb3 .left
     990/     913 : 24 75                       jmp .skip
     991/     915 :                     
     992/     915 :                         .up:
     993/     915 : BD 01                       mov r5, #DIR_UP
     994/     917 : FC                          mov a, r4
     995/     918 : 53 08                       anl a, #DIR_LEFT
     996/     91A : C6 20                       jz +
     997/     91C : B9 9D                       mov r1, #calc_extram_char(SNAKE_RIGHT, TILE_GREEN)
     998/     91E : 24 65                       jmp .accept
     999/     920 :                         +:
    1000/     920 : FC                          mov a, r4
    1001/     921 : 53 02                       anl a, #DIR_RIGHT
    1002/     923 : C6 75                       jz .skip
    1003/     925 : B9 A5                       mov r1, #calc_extram_char(SNAKE_LEFT, TILE_GREEN)
    1004/     927 : 24 65                       jmp .accept
    1005/     929 :                     
    1006/     929 :                         .right:
    1007/     929 : BD 02                       mov r5, #DIR_RIGHT
    1008/     92B : FC                          mov a, r4
    1009/     92C : 53 01                       anl a, #DIR_UP
    1010/     92E : C6 34                       jz +
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 35 - 01/22/2022 23:17:32


    1011/     930 : B9 9D                       mov r1, #calc_extram_char(SNAKE_RIGHT, TILE_GREEN)
    1012/     932 : 24 65                       jmp .accept
    1013/     934 :                         +:
    1014/     934 : FC                          mov a, r4
    1015/     935 : 53 04                       anl a, #DIR_DOWN
    1016/     937 : C6 75                       jz .skip
    1017/     939 : B9 9D                       mov r1, #calc_extram_char(SNAKE_RIGHT, TILE_GREEN)
    1018/     93B : 24 65                       jmp .accept
    1019/     93D :                     
    1020/     93D :                         .down:
    1021/     93D : BD 04                       mov r5, #DIR_DOWN
    1022/     93F : FC                          mov a, r4
    1023/     940 : 53 08                       anl a, #DIR_LEFT
    1024/     942 : C6 48                       jz +
    1025/     944 : B9 A5                       mov r1, #calc_extram_char(SNAKE_LEFT, TILE_GREEN)
    1026/     946 : 24 65                       jmp .accept
    1027/     948 :                         +:
    1028/     948 : FC                          mov a, r4
    1029/     949 : 53 02                       anl a, #DIR_RIGHT
    1030/     94B : C6 75                       jz .skip
    1031/     94D : B9 9D                       mov r1, #calc_extram_char(SNAKE_RIGHT, TILE_GREEN)
    1032/     94F : 24 65                       jmp .accept
    1033/     951 :                     
    1034/     951 :                         .left:
    1035/     951 : BD 08                       mov r5, #DIR_LEFT
    1036/     953 : FC                          mov a, r4
    1037/     954 : 53 01                       anl a, #DIR_UP
    1038/     956 : C6 5C                       jz +
    1039/     958 : B9 A5                       mov r1, #calc_extram_char(SNAKE_LEFT, TILE_GREEN)
    1040/     95A : 24 65                       jmp .accept
    1041/     95C :                         +:
    1042/     95C : FC                          mov a, r4
    1043/     95D : 53 04                       anl a, #DIR_DOWN
    1044/     95F : C6 75                       jz .skip
    1045/     961 : B9 A5                       mov r1, #calc_extram_char(SNAKE_LEFT, TILE_GREEN)
    1046/     963 : 24 65                       jmp .accept
    1047/     965 :                     
    1048/     965 :                         .accept:
    1049/     965 :                             ; extram snake end x
    1050/     965 : B8 6E                       mov r0, #EXTRAM_SNAKE_END_X
    1051/     967 : 80                          movx a, @r0
    1052/     968 : AA                          mov r2, a
    1053/     969 :                             ; extram snake end y
    1054/     969 : B8 6F                       mov r0, #EXTRAM_SNAKE_END_Y
    1055/     96B : 80                          movx a, @r0
    1056/     96C : AB                          mov r3, a
    1057/     96D :                             ; Write to current sprite pos
    1058/     96D : 54 CB                       call routine_write_extram_char
    1059/     96F :                     
    1060/     96F :                             ; Write direction to extram and continue
    1061/     96F : FD                          mov a, r5
    1062/     970 : B8 70                       mov r0, #EXTRAM_SNAKE_END_DIR
    1063/     972 : 90                          movx @r0, a
    1064/     973 : 24 90                       jmp move_head
    1065/     975 :                     
    1066/     975 :                         .skip:
    1067/     975 :                             ; extram snake end x
    1068/     975 : B8 6E                       mov r0, #EXTRAM_SNAKE_END_X
    1069/     977 : 80                          movx a, @r0
    1070/     978 : AA                          mov r2, a
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 36 - 01/22/2022 23:17:32


    1071/     979 :                             ; extram snake end y
    1072/     979 : B8 6F                       mov r0, #EXTRAM_SNAKE_END_Y
    1073/     97B : 80                          movx a, @r0
    1074/     97C : AB                          mov r3, a
    1075/     97D :                             ; Write to current sprite pos
    1076/     97D : B9 D5                       mov r1, #calc_extram_char(SNAKE_TILE, TILE_GREEN)
    1077/     97F : 54 CB                       call routine_write_extram_char
    1078/     981 :                     
    1079/     981 : 24 90                       jmp move_head
    1080/     983 :                     
    1081/     983 :                             align 16
    1082/     990 :                     
    1083/     990 :                     move_head:
    1084/     990 :                             ; extram snake end x
    1085/     990 : B8 6E                       mov r0, #EXTRAM_SNAKE_END_X
    1086/     992 : 80                          movx a, @r0
    1087/     993 : AA                          mov r2, a
    1088/     994 :                             ; extram snake end y
    1089/     994 : B8 6F                       mov r0, #EXTRAM_SNAKE_END_Y
    1090/     996 : 80                          movx a, @r0
    1091/     997 : AB                          mov r3, a
    1092/     998 :                             ; extram snake dir
    1093/     998 : B8 70                       mov r0, #EXTRAM_SNAKE_END_DIR
    1094/     99A : 80                          movx a, @r0
    1095/     99B :                     
    1096/     99B : 12 AF                       jb0 .up
    1097/     99D : 32 BD                       jb1 .right
    1098/     99F : 52 CB                       jb2 .down
    1099/     9A1 :                             ; jb3 .left
    1100/     9A1 :                         .left:
    1101/     9A1 :                             ; Check position
    1102/     9A1 : FA                          mov a, r2
    1103/     9A2 : 03 00                       add a, #0
    1104/     9A4 : 96 A8                       jnz +
    1105/     9A6 : 44 20                       jmp game_over
    1106/     9A8 :                             
    1107/     9A8 :                             ; Update position
    1108/     9A8 :                         +:
    1109/     9A8 : CA                          dec r2
    1110/     9A9 : B8 6E                       mov r0, #EXTRAM_SNAKE_END_X
    1111/     9AB : FA                          mov a, r2
    1112/     9AC : 90                          movx @r0, a
    1113/     9AD : 24 D9                       jmp .done
    1114/     9AF :                         .up:
    1115/     9AF :                             ; Check position
    1116/     9AF : FB                          mov a, r3
    1117/     9B0 : 03 FE                       add a, #-(2)
    1118/     9B2 : F6 B6                       jc +
    1119/     9B4 : 44 20                       jmp game_over
    1120/     9B6 :                             
    1121/     9B6 :                             ; Update position
    1122/     9B6 :                         +:
    1123/     9B6 : CB                          dec r3
    1124/     9B7 : B8 6F                       mov r0, #EXTRAM_SNAKE_END_Y
    1125/     9B9 : FB                          mov a, r3
    1126/     9BA : 90                          movx @r0, a
    1127/     9BB : 24 D9                       jmp .done
    1128/     9BD :                         .right:
    1129/     9BD :                             ; Check position
    1130/     9BD : FA                          mov a, r2
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 37 - 01/22/2022 23:17:32


    1131/     9BE : 03 F5                       add a, #-11
    1132/     9C0 : E6 C4                       jnc +
    1133/     9C2 : 44 20                       jmp game_over
    1134/     9C4 :                             
    1135/     9C4 :                             ; Update position
    1136/     9C4 :                         +:
    1137/     9C4 : 1A                          inc r2
    1138/     9C5 : B8 6E                       mov r0, #EXTRAM_SNAKE_END_X
    1139/     9C7 : FA                          mov a, r2
    1140/     9C8 : 90                          movx @r0, a
    1141/     9C9 : 24 D9                       jmp .done
    1142/     9CB :                         .down:
    1143/     9CB :                             ; Check position
    1144/     9CB : FB                          mov a, r3
    1145/     9CC : 03 F9                       add a, #-7
    1146/     9CE : E6 D2                       jnc +
    1147/     9D0 : 44 20                       jmp game_over
    1148/     9D2 :                             
    1149/     9D2 :                             ; Update position
    1150/     9D2 :                         +:
    1151/     9D2 : 1B                          inc r3
    1152/     9D3 : B8 6F                       mov r0, #EXTRAM_SNAKE_END_Y
    1153/     9D5 : FB                          mov a, r3
    1154/     9D6 : 90                          movx @r0, a
    1155/     9D7 : 24 D9                       jmp .done
    1156/     9D9 :                     
    1157/     9D9 :                         .done:
    1158/     9D9 :                             ; Copy X and Y to backup registers
    1159/     9D9 : FA                          mov a, r2
    1160/     9DA : AC                          mov r4, a
    1161/     9DB : FB                          mov a, r3
    1162/     9DC : AD                          mov r5, a
    1163/     9DD :                     
    1164/     9DD :                     check_target_tile:
    1165/     9DD :                             ; Read tile at this location
    1166/     9DD : 54 DB                       call routine_read_extram_char
    1167/     9DF : AE                          mov r6, a
    1168/     9E0 :                     
    1169/     9E0 :                             ; Write tile
    1170/     9E0 : FC                          mov a, r4
    1171/     9E1 : AA                          mov r2, a
    1172/     9E2 : FD                          mov a, r5
    1173/     9E3 : AB                          mov r3, a
    1174/     9E4 : B9 D7                       mov r1, #calc_extram_char(SNAKE_TILE, TILE_BLUE)
    1175/     9E6 : 54 CB                       call routine_write_extram_char
    1176/     9E8 :                     
    1177/     9E8 :                             ; Check overwritten tile for apple
    1178/     9E8 : FE                          mov a, r6
    1179/     9E9 : 03 CF                       add a, #-(APPLE_TILE)
    1180/     9EB : C6 EF                       jz .ate_apple
    1181/     9ED : 44 16                       jmp .check_collision
    1182/     9EF :                     
    1183/     9EF :                         .ate_apple:
    1184/     9EF :                             ; Update the apple position
    1185/     9EF : 54 8C                       call new_apple_position
    1186/     9F1 :                     
    1187/     9F1 :                             ; increment score
    1188/     9F1 : B8 6A                       mov r0, #EXTRAM_SCORE
    1189/     9F3 : 80                          movx a, @r0
    1190/     9F4 : 03 01                       add a, #01h
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 38 - 01/22/2022 23:17:32


    1191/     9F6 : 57                          da a
    1192/     9F7 : 90                          movx @r0, a
    1193/     9F8 :                             ; update display
    1194/     9F8 : 53 0F                       anl a, #1111b
    1195/     9FA : E7                          rl a
    1196/     9FB : E7                          rl a
    1197/     9FC : E7                          rl a
    1198/     9FD : A9                          mov r1, a
    1199/     9FE : BA 09                       mov r2, #9
    1200/     A00 : BB 00                       mov r3, #0
    1201/     A02 : 54 CB                       call routine_write_extram_char
    1202/     A04 : B8 6A                       mov r0, #EXTRAM_SCORE
    1203/     A06 : 80                          movx a, @r0
    1204/     A07 : 47                          swap a
    1205/     A08 : 53 0F                       anl a, #1111b
    1206/     A0A : E7                          rl a
    1207/     A0B : E7                          rl a
    1208/     A0C : E7                          rl a
    1209/     A0D : A9                          mov r1, a
    1210/     A0E : BA 08                       mov r2, #8
    1211/     A10 : BB 00                       mov r3, #0
    1212/     A12 : 54 CB                       call routine_write_extram_char
    1213/     A14 :                     
    1214/     A14 :                             ; loop game
    1215/     A14 : 04 84                       jmp main_loop
    1216/     A16 :                     
    1217/     A16 :                             ; Check overwritten tile for snake
    1218/     A16 :                         .check_collision:
    1219/     A16 : FE                          mov a, r6
    1220/     A17 : 03 F4                       add a, #-(EMPTY_TILE)
    1221/     A19 : C6 1D                       jz +
    1222/     A1B : 44 20                       jmp game_over
    1223/     A1D :                     
    1224/     A1D :                         +:
    1225/     A1D : 44 3A                       jmp move_tail
    1226/     A1F :                     
    1227/     A1F :                             align 16
    1228/     A20 :                     
    1229/     A20 :                     game_over:
    1230/     A20 :                             ; draw red X where we ended
    1231/     A20 : B9 13                       mov r1, #calc_extram_char('X', TILE_RED)
    1232/     A22 :                             ; extram snake end x
    1233/     A22 : B8 6E                       mov r0, #EXTRAM_SNAKE_END_X
    1234/     A24 : 80                          movx a, @r0
    1235/     A25 : AA                          mov r2, a
    1236/     A26 :                             ; extram snake end y
    1237/     A26 : B8 6F                       mov r0, #EXTRAM_SNAKE_END_Y
    1238/     A28 : 80                          movx a, @r0
    1239/     A29 : AB                          mov r3, a
    1240/     A2A : 54 CB                       call routine_write_extram_char
    1241/     A2C :                     
    1242/     A2C :                             ; wait for keypress
    1243/     A2C : B8 3B                       mov r0, #iram_keyboard
    1244/     A2E : 27                          clr a
    1245/     A2F : A0                          mov @r0, a
    1246/     A30 :                     
    1247/     A30 :                         -:
    1248/     A30 : F0                          mov a, @r0
    1249/     A31 : 92 35                       jb4 +
    1250/     A33 : 44 30                       jmp -
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 39 - 01/22/2022 23:17:32


    1251/     A35 :                         +:
    1252/     A35 : 15                          dis i
    1253/     A36 : 35                          dis	tcnti
    1254/     A37 : E5 84 0C                    jmp bank0_start
    1255/     A3A :                     
    1256/     A3A :                     
    1257/     A3A :                     
    1258/     A3A :                             ; load tail position
    1259/     A3A :                     move_tail:
    1260/     A3A :                             ; extram snake end x
    1261/     A3A : B8 6B                       mov r0, #EXTRAM_SNAKE_START_X
    1262/     A3C : 80                          movx a, @r0
    1263/     A3D : AC                          mov r4, a
    1264/     A3E :                             ; extram snake end y
    1265/     A3E : B8 6C                       mov r0, #EXTRAM_SNAKE_START_Y
    1266/     A40 : 80                          movx a, @r0
    1267/     A41 : AD                          mov r5, a
    1268/     A42 :                     
    1269/     A42 : FC                          mov a, r4
    1270/     A43 : AA                          mov r2, a
    1271/     A44 : FD                          mov a, r5
    1272/     A45 : AB                          mov r3, a
    1273/     A46 : 54 DB                       call routine_read_extram_char
    1274/     A48 : A8                          mov r0, a
    1275/     A49 : B9 6D                       mov r1, #EXTRAM_SNAKE_START_DIR
    1276/     A4B : 81                          movx a, @r1
    1277/     A4C : A9                          mov r1, a
    1278/     A4D : 74 0C                       call get_dir_from_char
    1279/     A4F : B9 6D                       mov r1, #EXTRAM_SNAKE_START_DIR
    1280/     A51 : 91                          movx @r1, a
    1281/     A52 :                             ; Save the direction
    1282/     A52 : AE                          mov r6, a
    1283/     A53 :                     
    1284/     A53 :                         .erase_tile:
    1285/     A53 : B9 64                       mov r1, #calc_extram_char(EMPTY_TILE, TILE_GREEN)
    1286/     A55 : FC                          mov a, r4
    1287/     A56 : AA                          mov r2, a
    1288/     A57 : FD                          mov a, r5
    1289/     A58 : AB                          mov r3, a
    1290/     A59 : 54 CB                       call routine_write_extram_char
    1291/     A5B :                     
    1292/     A5B :                     update_tail_position:
    1293/     A5B : FE                          mov a, r6
    1294/     A5C : 12 77                       jb0 .up
    1295/     A5E : 32 70                       jb1 .right
    1296/     A60 : 52 69                       jb2 .down
    1297/     A62 :                         .left:
    1298/     A62 : B8 6B                       mov r0, #EXTRAM_SNAKE_START_X
    1299/     A64 : 80                          movx a, @r0
    1300/     A65 : 07                          dec a
    1301/     A66 : 90                          movx @r0, a
    1302/     A67 : 44 7C                       jmp .done
    1303/     A69 :                         .down:
    1304/     A69 : B8 6C                       mov r0, #EXTRAM_SNAKE_START_Y
    1305/     A6B : 80                          movx a, @r0
    1306/     A6C : 17                          inc a
    1307/     A6D : 90                          movx @r0, a
    1308/     A6E : 44 7C                       jmp .done
    1309/     A70 :                         .right:
    1310/     A70 : B8 6B                       mov r0, #EXTRAM_SNAKE_START_X
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 40 - 01/22/2022 23:17:32


    1311/     A72 : 80                          movx a, @r0
    1312/     A73 : 17                          inc a
    1313/     A74 : 90                          movx @r0, a
    1314/     A75 : 44 7C                       jmp .done
    1315/     A77 :                         .up:
    1316/     A77 : B8 6C                       mov r0, #EXTRAM_SNAKE_START_Y
    1317/     A79 : 80                          movx a, @r0
    1318/     A7A : 07                          dec a
    1319/     A7B : 90                          movx @r0, a
    1320/     A7C :                             ; jmp .done
    1321/     A7C :                     
    1322/     A7C :                         .done:
    1323/     A7C : 04 84                       jmp main_loop
    1324/     A7E :                     
    1325/     A7E :                     
    1326/     A7E :                     
    1327/     A7E :                     
    1328/     A7E :                     
    1329/     A7E :                     
    1330/     A7E :                     ; other methods
    1331/     A7E :                     
    1332/     A7E :                     divide_method:
    1333/     A7E : BC FF                       mov r4, #0ffh
    1334/     A80 : FB                          mov a, r3
    1335/     A81 : 37                          cpl a
    1336/     A82 : 17                          inc a
    1337/     A83 : AE                          mov r6, a
    1338/     A84 : FA                          mov a, r2
    1339/     A85 :                         -:
    1340/     A85 : 6E                          add a, r6	; r2 - r3
    1341/     A86 : 1C                          inc r4
    1342/     A87 : F6 85                       jc -
    1343/     A89 : 6B                          add a, r3
    1344/     A8A : AD                          mov r5, a
    1345/     A8B : 83                          ret
    1346/     A8C :                     
    1347/     A8C :                     
    1348/     A8C :                     
    1349/     A8C :                     new_apple_position:
    1350/     A8C :                     
    1351/     A8C :                         .loop_to_find_locatioon:
    1352/     A8C : 54 C0                       call get_random_number
    1353/     A8E : AA                          mov r2, a
    1354/     A8F :                             ; extram apple y
    1355/     A8F :                             ; mov a, #7
    1356/     A8F :                             ; mov r0, #EXTRAM_APPLE_Y
    1357/     A8F :                             ; movx @r0, a
    1358/     A8F :                             ; modulus
    1359/     A8F : BB 07                       mov r3, #7
    1360/     A91 : 54 7E                       call divide_method
    1361/     A93 : FD                          mov a, r5
    1362/     A94 : 17                          inc a
    1363/     A95 : AF                          mov r7, a
    1364/     A96 :                     
    1365/     A96 : 54 C0                       call get_random_number
    1366/     A98 : AA                          mov r2, a
    1367/     A99 :                             ; extram apple x
    1368/     A99 :                             ; mov a, #12
    1369/     A99 :                             ; mov r0, #EXTRAM_APPLE_X
    1370/     A99 :                             ; movx @r0, a
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 41 - 01/22/2022 23:17:32


    1371/     A99 :                             ; modulus
    1372/     A99 : BB 0C                       mov r3, #12
    1373/     A9B : 54 7E                       call divide_method
    1374/     A9D : FD                          mov a, r5
    1375/     A9E : 17                          inc a
    1376/     A9F : AA                          mov r2, a
    1377/     AA0 : AD                          mov r5, a
    1378/     AA1 :                             ; move y register
    1379/     AA1 : FF                          mov a, r7
    1380/     AA2 : AB                          mov r3, a
    1381/     AA3 : AE                          mov r6, a
    1382/     AA4 :                     
    1383/     AA4 :                             ; check tile contents
    1384/     AA4 : 54 DB                       call routine_read_extram_char
    1385/     AA6 : 03 F4                       add a, #-EMPTY_TILE
    1386/     AA8 :                             ; jnz .main_loop_reset
    1387/     AA8 : 96 8C                       jnz .loop_to_find_locatioon
    1388/     AAA :                     
    1389/     AAA :                         draw_apple:
    1390/     AAA :                             ; draw apple tile
    1391/     AAA : B9 8B                       mov r1, #calc_extram_char(APPLE_TILE, TILE_RED)
    1392/     AAC : FD                          mov a, r5
    1393/     AAD : AA                          mov r2, a
    1394/     AAE : FE                          mov a, r6
    1395/     AAF : AB                          mov r3, a
    1396/     AB0 :                             ; mov r2, #8
    1397/     AB0 :                             ; mov r3, #2
    1398/     AB0 : 54 CB                       call routine_write_extram_char
    1399/     AB2 :                     
    1400/     AB2 :                         +:
    1401/     AB2 : 93                          retr
    1402/     AB3 :                     
    1403/     AB3 :                     
    1404/     AB3 :                             ; lookup tile for the apple
    1405/     AB3 :                         ;     mov r2, #8
    1406/     AB3 :                         ;     mov r3, #2
    1407/     AB3 :                         ;     call routine_read_extram_char
    1408/     AB3 :                         ;     add a, #-APPLE_TILE
    1409/     AB3 :                         ;     ; jnz .main_loop_reset
    1410/     AB3 :                         ;     jnz .other_check
    1411/     AB3 :                     
    1412/     AB3 :                         ;     ; jmp bank0_start
    1413/     AB3 :                     
    1414/     AB3 :                         ;     ; write a blue apple
    1415/     AB3 :                         ;     write_extram_char 48, 8, 2, TILE_BLUE
    1416/     AB3 :                     
    1417/     AB3 :                         ;     jmp .main_loop_reset
    1418/     AB3 :                         
    1419/     AB3 :                         ; .other_check:
    1420/     AB3 :                         ;     write_extram_char 49, 8, 2, TILE_RED
    1421/     AB3 :                     
    1422/     AB3 :                         ;     jmp .main_loop_reset
    1423/     AB3 :                     
    1424/     AB3 :                             ; ; lookup tile for the snake end and set r2=x, r3=y
    1425/     AB3 :                             ; mov r0, #EXTRAM_SNAKE_START_X
    1426/     AB3 :                             ; movx a, @r0
    1427/     AB3 :                             ; mov r2, a
    1428/     AB3 :                             ; mov r0, #EXTRAM_SNAKE_START_Y
    1429/     AB3 :                             ; movx a, @r0
    1430/     AB3 :                             ; mov r3, a
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 42 - 01/22/2022 23:17:32


    1431/     AB3 :                             ; call routine_read_extram_char
    1432/     AB3 :                     
    1433/     AB3 :                             ; ; does R1 hold an APPLE_TILE icon
    1434/     AB3 :                             ; ; mov r1, a
    1435/     AB3 :                             ; add a, #-49
    1436/     AB3 :                             ; jnz .main_loop_reset
    1437/     AB3 :                     
    1438/     AB3 :                     
    1439/     AB3 :                             align 16
    1440/     AC0 :                     
    1441/     AC0 :                             ; out a = random
    1442/     AC0 :                     get_random_number:
    1443/     AC0 :                             ; https://github.com/7800-devtools/lfsr6502/blob/master/README.txt
    1444/     AC0 : B8 3D                       mov r0, #iram_random
    1445/     AC2 : F0                          mov a, @r0
    1446/     AC3 :                     
    1447/     AC3 : 97                          clr c
    1448/     AC4 : 67                          rrc a
    1449/     AC5 : E6 C9                       jnc .no_eor
    1450/     AC7 : D3 B4                       xrl a, #$B4
    1451/     AC9 :                         .no_eor:
    1452/     AC9 : A0                          mov @r0, a
    1453/     ACA : 93                          retr
    1454/     ACB :                     
    1455/     ACB :                             ; r1 = calc_extram_char(char, color)
    1456/     ACB :                             ; r2 = x
    1457/     ACB :                             ; r3 = y
    1458/     ACB :                     routine_write_extram_char:
    1459/     ACB : FB                          mov a, r3
    1460/     ACC : E7                          rl a
    1461/     ACD : E7                          rl a
    1462/     ACE : AB                          mov r3, a
    1463/     ACF : E7                          rl a
    1464/     AD0 : 6B                          add a, r3
    1465/     AD1 : 6A                          add a, r2
    1466/     AD2 :                     
    1467/     AD2 :                             ; prevent overflow
    1468/     AD2 : A8                          mov r0, a
    1469/     AD3 : 03 A0                       add a, #-(12*8)
    1470/     AD5 : F2 D8                       jb7 +
    1471/     AD7 : 93                          retr
    1472/     AD8 :                     
    1473/     AD8 :                         +:
    1474/     AD8 :                             ; lookup
    1475/     AD8 :                             ; mov r0, a
    1476/     AD8 : F9                          mov a, r1
    1477/     AD9 : 90                          movx @r0, a
    1478/     ADA : 93                          retr
    1479/     ADB :                     
    1480/     ADB :                             ; r2 = x
    1481/     ADB :                             ; r3 = y
    1482/     ADB :                             ; out a = character
    1483/     ADB :                     routine_read_extram_char:
    1484/     ADB : FB                          mov a, r3
    1485/     ADC : E7                          rl a
    1486/     ADD : E7                          rl a
    1487/     ADE : AB                          mov r3, a
    1488/     ADF : E7                          rl a
    1489/     AE0 : 6B                          add a, r3
    1490/     AE1 : 6A                          add a, r2
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 43 - 01/22/2022 23:17:32


    1491/     AE2 : A8                          mov r0, a
    1492/     AE3 :                     
    1493/     AE3 :                             ; lookup
    1494/     AE3 : 80                          movx a, @r0
    1495/     AE4 : 77                          rr a
    1496/     AE5 : 77                          rr a
    1497/     AE6 : 77                          rr a
    1498/     AE7 : 53 3F                       anl a, #00111111b
    1499/     AE9 :                     
    1500/     AE9 : 93                          retr
    1501/     AEA :                     
    1502/     AEA :                     
    1503/     AEA :                             align 64
    1504/     B00 :                     
    1505/     B00 :                     get_dir_from_char_lookup:
    1506/     B00 : 01 08 02                    db DIR_UP,      DIR_LEFT,   DIR_RIGHT
    1507/     B03 : 02 01 04                    db DIR_RIGHT,   DIR_UP,     DIR_DOWN
    1508/     B06 : 04 08 02                    db DIR_DOWN,    DIR_LEFT,   DIR_RIGHT
    1509/     B09 : 08 04 01                    db DIR_LEFT,    DIR_DOWN,   DIR_UP
    1510/     B0C :                     
    1511/     B0C :                             ; r0 = char
    1512/     B0C :                             ; r1 = input dir
    1513/     B0C :                             ; out a = dir
    1514/     B0C :                     get_dir_from_char:
    1515/     B0C : F9                          mov a, r1
    1516/     B0D : 12 1F                       jb0 .up
    1517/     B0F : 32 1B                       jb1 .right
    1518/     B11 : 52 17                       jb2 .down
    1519/     B13 :                         .left:
    1520/     B13 : B9 09                       mov r1, #9
    1521/     B15 : 64 23                       jmp .char_lookup
    1522/     B17 :                         .down:
    1523/     B17 : B9 06                       mov r1, #6
    1524/     B19 : 64 23                       jmp .char_lookup
    1525/     B1B :                         .right:
    1526/     B1B : B9 03                       mov r1, #3
    1527/     B1D : 64 23                       jmp .char_lookup
    1528/     B1F :                         .up:
    1529/     B1F : B9 00                       mov r1, #0
    1530/     B21 : 64 23                       jmp .char_lookup
    1531/     B23 :                     
    1532/     B23 :                         .char_lookup:
    1533/     B23 : F8                          mov a, r0
    1534/     B24 : 03 CD                       add a, #-SNAKE_RIGHT
    1535/     B26 : 96 2D                       jnz +
    1536/     B28 : F9                          mov a, r1
    1537/     B29 : 03 02                       add a, #2 + lo(get_dir_from_char_lookup)
    1538/     B2B : A3                          movp a, @a
    1539/     B2C : 93                          retr
    1540/     B2D :                         +:
    1541/     B2D : F8                          mov a, r0
    1542/     B2E : 03 CC                       add a, #-SNAKE_LEFT
    1543/     B30 : 96 37                       jnz +
    1544/     B32 : F9                          mov a, r1
    1545/     B33 : 03 01                       add a, #1 + lo(get_dir_from_char_lookup)
    1546/     B35 : A3                          movp a, @a
    1547/     B36 : 93                          retr
    1548/     B37 :                         +:
    1549/     B37 : F9                          mov a, r1
    1550/     B38 : 03 00                       add a, #0 + lo(get_dir_from_char_lookup)
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 44 - 01/22/2022 23:17:32


    1551/     B3A : A3                          movp a, @a
    1552/     B3B : 93                          retr
    1553/     B3C :                     
    1554/     B3C : (MACRO)                      assert "hi(get_dir_from_char_lookup) == hi($)"
    1554/     B3C : =>FALSE                      if (~~val("hi(get_dir_from_char_lookup) == hi($)"))
    1554/     B3C :                                 error "hi(get_dir_from_char_lookup) == hi($)"
    1554/     B3C : [1554]                       endif
    1555/     B3C :                     
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 45 - 01/22/2022 23:17:32


  Symbol Table (* = unused):
  --------------------------

 APPLE_TILE :                    31 - | *ARCHITECTURE :  "x86_64-apple-osx" - |
*BANK0 :                        387 - | *BANK01 :                       383 - |
*BANK02 :                       37F - |  BANK0_START :                  40C C |
*BANK3 :                        38B - | *BIGENDIAN :                      0 - |
*BITCLEAR :                     280 - | *BITFUNCSINC :                    1 - |
*BITSET :                       28A - | *BITTEST :                      26A - |
*BRANCHEXT :                      0 - | *CALCCHAR23 :                   14B - |
*CASESENSITIVE :                  0 - |  CHANGE_DIRECTION :             900 C |
 CHANGE_DIRECTION.ACCEPT :      965 C |  CHANGE_DIRECTION.DOWN :        93D C |
 CHANGE_DIRECTION.LEFT :        951 C |  CHANGE_DIRECTION.RIGHT :       929 C |
 CHANGE_DIRECTION.SKIP :        975 C |  CHANGE_DIRECTION.UP :          915 C |
*CHECK_TARGET_TILE :            9DD C |  CHECK_TARGET_TILE.ATE_APPLE :  9EF C |
 CHECK_TARGET_TILE.CHECK_COLLISION :                                   0A16 C |
*CLEARCHAR :                    16B - | *CLOCK_FORWARD :                 40 - |
*CLOCK_STOP :                    80 - |  COL_BCK_BLACK :                  0 - |
 COL_BCK_BLUE :                   8 - | *COL_BCK_CYAN :                  18 - |
*COL_BCK_GREEN :                 10 - | *COL_BCK_RED :                   20 - |
*COL_BCK_VIOLET :                28 - | *COL_BCK_WHITE :                 38 - |
*COL_BCK_YELLOW :                30 - | *COL_CHR_BLACK :                  0 - |
*COL_CHR_BLUE :                   8 - | *COL_CHR_CYAN :                  0C - |
 COL_CHR_GREEN :                  4 - |  COL_CHR_RED :                    2 - |
*COL_CHR_VIOLET :                0A - |  COL_CHR_WHITE :                 0E - |
 COL_CHR_YELLOW :                 6 - | *COL_GRD_BLACK :                  0 - |
*COL_GRD_BLUE :                   1 - | *COL_GRD_CYAN :                   3 - |
*COL_GRD_GREEN :                  2 - | *COL_GRD_LUM :                   40 - |
*COL_GRD_RED :                    4 - |  COL_GRD_VIOLET :                 5 - |
 COL_GRD_WHITE :                  7 - | *COL_GRD_YELLOW :                 6 - |
*COL_PATR_BLCK :                 80 - | *COL_PATR_DHGHT :                10 - |
*COL_PATR_DWDTH :                20 - | *COL_PATR_INVRT :                40 - |
*COL_PATR_STABLE :                8 - | *COL_PBCK_BLACK :                 0 - |
*COL_PBCK_BLUE :                 40 - | *COL_PBCK_CYAN :                 60 - |
*COL_PBCK_GREEN :                20 - | *COL_PBCK_RED :                  10 - |
*COL_PBCK_VIOLET :               50 - | *COL_PBCK_WHITE :                70 - |
*COL_PBCK_YELLOW :               30 - | *COL_PLUS_BLACK :                 0 - |
*COL_PLUS_BLUE :                  4 - | *COL_PLUS_CYAN :                  6 - |
*COL_PLUS_GREEN :                 2 - | *COL_PLUS_RED :                   1 - |
*COL_PLUS_VIOLET :                5 - | *COL_PLUS_WHITE :                 7 - |
*COL_PLUS_YELLOW :                3 - | *COL_SATR_BOX :                   2 - |
*COL_SATR_CONC :                  1 - | *COL_SATR_ENABLE :               80 - |
*COL_SATR_LINE :                  4 - | *COL_SPR_BLACK :                  0 - |
 COL_SPR_BLUE :                  20 - | *COL_SPR_CYAN :                  30 - |
*COL_SPR_GREEN :                 10 - | *COL_SPR_RED :                    8 - |
*COL_SPR_VIOLET :                28 - | *COL_SPR_WHITE :                 38 - |
*COL_SPR_YELLOW :                18 - | *COMPMODE :                       0 - |
 COMPUTE_CHARS :                630 C |  COMPUTE_CHAR_FROM_EXTRAM :     60A C |
 COMPUTE_CHAR_FROM_EXTRAM_MOV : 61D C | *COMPUTE_COLOR :                608 C |
 COMPUTE_PAGE :                 600 C | *CONSTPI :        3.141592653589793 - |
*COPYREGS :                      89 - | *CUSTOM :                         0 - |
*DATE :                "01/22/2022" - | *DECODEJOYSTICK :               3B1 - |
 DIR_DOWN :                       4 - |  DIR_LEFT :                       8 - |
 DIR_RIGHT :                      2 - |  DIR_UP :                         1 - |
*DIVIDE :                       3DD - |  DIVIDE_METHOD :               0A7E C |
*DOCLOCK :                      1B0 - | *DRAW_APPLE :                  0AAA C |
 DRAW_HELLOWORLD :              44A C |  DRAW_HELLOWORLD.COLUMN_11 :    4A3 C |
 DRAW_HELLOWORLD.COLUMN_9 :     48F C |  DRAW_HELLOWORLD.LOOP :         454 C |
*EIN_EEDO :                       1 - |  EMPTY_TILE :                   ' ' - |
*EOUT_EECLK :                     4 - | *EOUT_EECS :                      2 - |
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 46 - 01/22/2022 23:17:32


*EOUT_EEDI :                      8 - | *EOUT_TX :                        1 - |
*ERAM_MINUTES :                   1 - | *ERAM_SECONDS :                   2 - |
*EREG_CODEBANK :                 80 - | *EREG_DATABANK :                 81 - |
*EREG_IO_IN :                    83 - | *EREG_IO_OUT :                   82 - |
*EXTRAMENABLE :                 0EC - |  EXTRAM_FRAME :                  71 - |
 EXTRAM_SCORE :                  6A - |  EXTRAM_SNAKE_END_DIR :          70 - |
 EXTRAM_SNAKE_END_X :            6E - |  EXTRAM_SNAKE_END_Y :            6F - |
 EXTRAM_SNAKE_START_DIR :        6D - |  EXTRAM_SNAKE_START_X :          6B - |
 EXTRAM_SNAKE_START_Y :          6C - | *FALSE :                          0 - |
*FULLPMMU :                       1 - |  GAME_OVER :                   0A20 C |
 GETJOYSTICK :                  38F - | *GETJOYSTICK_P17 :              395 - |
 GET_DIR_FROM_CHAR :           0B0C C |
 GET_DIR_FROM_CHAR.CHAR_LOOKUP :                                       0B23 C |
 GET_DIR_FROM_CHAR.DOWN :      0B17 C | *GET_DIR_FROM_CHAR.LEFT :      0B13 C |
 GET_DIR_FROM_CHAR.RIGHT :     0B1B C |  GET_DIR_FROM_CHAR.UP :        0B1F C |
 GET_DIR_FROM_CHAR_LOOKUP :    0B00 C |  GET_RANDOM_NUMBER :           0AC0 C |
 GET_RANDOM_NUMBER.NO_EOR :    0AC9 C |  GFXOFF :                       11C - |
*GFXON :                        127 - | *HAS64 :                          1 - |
*HASDSP :                         0 - | *HASFPU :                         0 - |
*HASPMMU :                        0 - |  HELLOSTR :                     4B2 C |
*ICTRL_GAMEOVER :                20 - |  ICTRL_LINEIRQ :                 40 - |
*ICTRL_NEXTFRAME :               80 - | *INEXTMODE :                      0 - |
*INIT :                         0F1 - | *INITCLOCK :                    23A - |
*INIT_GRID :                    431 C |  INIT_GRID.LOOPGV :             435 C |
*INIT_TEXT :                    445 C | *INLWORDMODE :                    0 - |
*INMAXMODE :                      0 - | *INSRCMODE :                      0 - |
*INSUPMODE :                      0 - | *IRAM_CLOCK :                    3E - |
*IRAM_COLLISION :                3D - |  IRAM_ICTRL :                    3C - |
 IRAM_IRAM_INDEX :               3A - |  IRAM_IRQCTRL :                  3F - |
 IRAM_KEYBOARD :                 3B - |  IRAM_RANDOM :                   3D - |
*IRAM_REWRITE_END :              39 - |  IRAM_REWRITE_START :            36 - |
*IRAM_TILE_COMPUTE_END :         35 - |  IRAM_TILE_COMPUTE_START :       20 - |
 IRAM_VBLANK_BKP_A :             16 - |  IRAM_VBLANK_BKP_P1 :            17 - |
 IRQ :                            9 - | *IRQEND :                        14 - |
*IRQ_SOUND :                     40 - | *IRQ_TABLE :                     80 - |
*LISTON :                         1 - | *MACEXP :                         7 - |
 MAIN :                         800 C |  MAIN.CNT :                       2 - |
 MAIN_LOOP :                    884 C |  MAIN_LOOP.MAIN_LOOP_START :    88A C |
 MAIN_LOOP.NEXT_FRAME :         8A7 C | *MOMCPU :                      8048 - |
*MOMCPUNAME :                "8048" - |  MOVE_HEAD :                    990 C |
 MOVE_HEAD.DONE :               9D9 C |  MOVE_HEAD.DOWN :               9CB C |
*MOVE_HEAD.LEFT :               9A1 C |  MOVE_HEAD.RIGHT :              9BD C |
 MOVE_HEAD.UP :                 9AF C |  MOVE_TAIL :                   0A3A C |
*MOVE_TAIL.ERASE_TILE :        0A53 C | *MULTIPLY :                     3CF - |
 MYVSYNCIRQ :                   4C0 C |
*MYVSYNCIRQ.CONTINUE_VBLANK_IRQ :                                       588 C |
 MYVSYNCIRQ.COUNT :               6 - |  MYVSYNCIRQ.SETUP_FRAME :       4CF C |
 MYVSYNCIRQ.SKIP_LINE_IRQ :     4C8 C |
*MYVSYNCIRQ.WRITE_INDIVIDUAL_CHARS :                                    4EE C |
*NESTMAX :                      100 - |  NEW_APPLE_POSITION :          0A8C C |
 NEW_APPLE_POSITION.LOOP_TO_FIND_LOCATIOON :                           0A8C C |
*NIBBLEMIXER :                  2A4 - | *PACKING :                        0 - |
*PADDING :                        1 - | *PARSESND :                      4B - |
*PLAYSOUND :                    1A2 - | *PLUSCMD :                      288 - |
*PLUSDATA :                     28C - | *PLUSENABLE :                   2A1 - |
*PLUSHIDE :                     296 - | *PLUSLOADR :                    283 - |
*PLUSMODE :                     299 - | *PLUSREADY :                    27D - |
*PLUSSELECTGAME :               2C2 - | *PLUSSTART :                    2AB - |
*PLUS_BLCK_FULL :                40 - | *PLUS_CMD_BROW :                  0 - |
*PLUS_CMD_INCC :                 60 - | *PLUS_CMD_LOADM :                80 - |
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 47 - 01/22/2022 23:17:32


*PLUS_CMD_LOADR :               0A0 - | *PLUS_CMD_LOADX :                40 - |
*PLUS_CMD_LOADY :                20 - | *PLUS_CMD_LOADY0 :              0C0 - |
*PLUS_LOADM_RD :                 20 - | *PLUS_LOADM_RDNI :               60 - |
*PLUS_LOADM_RDSL :              0A0 - | *PLUS_LOADM_WR :                  0 - |
*PLUS_LOADM_WRNI :               40 - | *PLUS_LOADM_WRSL :               80 - |
*PLUS_LOADR_BLNK :               80 - | *PLUS_LOADR_BOX :                 2 - |
*PLUS_LOADR_CONC :                4 - | *PLUS_LOADR_CRSR :               10 - |
*PLUS_LOADR_DSPL :                1 - | *PLUS_LOADR_SROW :                8 - |
*PLUS_LOADR_TL :                 20 - | *PLUS_LOADR_TT :                 40 - |
*PLUS_LOADY0_ZOM :               20 - |  PRINTCHAR :                    3EA - |
*PUTCHAR23 :                    261 - | *RANDOM :                       293 - |
*READKEY :                      0B0 - | *READKEY_PLUS :                 0BC - |
*RELAXED :                        1 - |  ROUTINE_READ_EXTRAM_CHAR :    0ADB C |
 ROUTINE_WRITE_EXTRAM_CHAR :   0ACB C | *ROW_WRITE_TO_VDC :             6FD C |
*ROW_WRITE_TO_VDC.CRITICAL_ZONE :                                       707 C |
*ROW_WRITE_TO_VDC.SLEEP_UNTIL_NEXT_ROW :                                783 C |
 SELECTGAME :                   2C3 - |  SNAKE_LEFT :                    34 - |
 SNAKE_RIGHT :                   33 - |  SNAKE_TILE :                    3A - |
 SOUNDIRQ :                      44 - | *SPR_DOUBLE :                     4 - |
*SPR_EVENSHIFT :                  2 - | *TABLEBCDBYTE :                 17C - |
*TABLEBCDNIBBLE :               229 - | *TABLECHAR23 :                  22C - |
*TABLEEND :                     132 - | *TABLEPRINTCHAR :               197 - |
*TABLEPUT2 :                    235 - |  TEXT_HI_YPOS :                  0C - |
 TEXT_XPOS :                     68 - |  TEXT_XPOS2 :                    28 - |
 TILE_BLUE :                      3 - |  TILE_GREEN :                     2 - |
 TILE_RED :                       1 - |  TILE_WHITE :                     0 - |
*TIME :                  "23:17:32" - |  TIMEIRQ :                      590 C |
*TIMEIRQ.FINISH_FRAME :         5ED C |  TIMING_AFTER_COMPUTE :          29 - |
 TIMING_CYCLES_TO_FIRST_ROW :    13 - |  TIMING_SCANLINE_START :        0F4 - |
 TIMING_VDC_WRITE_PADDING :       2 - |
 TIMING_Y_START_OFFSET :                                  0FFFFFFFFFFFFFFF0 - |
*TRUE :                           1 - | *TUNE_ALARM :                    3C - |
*TUNE_BEEP_ERROR :               28 - | *TUNE_BUZZ :                     5A - |
*TUNE_EXPLODE :                  2E - | *TUNE_KEYCLICK :                 56 - |
*TUNE_SELECT :                   4A - | *TUNE_SELECT2 :                  5E - |
*TUNE_SHOOT :                    6A - | *UPDATE_TAIL_POSITION :        0A5B C |
 UPDATE_TAIL_POSITION.DONE :   0A7C C |  UPDATE_TAIL_POSITION.DOWN :   0A69 C |
*UPDATE_TAIL_POSITION.LEFT :   0A62 C |  UPDATE_TAIL_POSITION.RIGHT :  0A70 C |
 UPDATE_TAIL_POSITION.UP :     0A77 C | *VDCENABLE :                    0E7 - |
 VDC_CHAR0 :                     10 - | *VDC_CHAR1 :                     14 - |
*VDC_CHAR2 :                     18 - | *VDC_CHAR3 :                     1C - |
*VDC_CHAR4 :                     20 - | *VDC_CHAR5 :                     24 - |
 VDC_CHAR6 :                     28 - | *VDC_CHAR7 :                     2C - |
*VDC_CHAR8 :                     30 - | *VDC_CHAR9 :                     34 - |
*VDC_CHARA :                     38 - | *VDC_CHARB :                     3C - |
*VDC_COLLISION :                0A2 - | *VDC_COLL_CHAR :                 80 - |
*VDC_COLL_EXT :                  40 - | *VDC_COLL_HGRD :                 20 - |
*VDC_COLL_SPR0 :                  1 - | *VDC_COLL_SPR1 :                  2 - |
*VDC_COLL_SPR2 :                  4 - | *VDC_COLL_SPR3 :                  8 - |
*VDC_COLL_VGRD :                 10 - |  VDC_COLOR :                    0A3 - |
*VDC_CONTROL :                  0A0 - | *VDC_CTRL_BEAM :                  2 - |
*VDC_CTRL_DOT :                  40 - | *VDC_CTRL_FILL :                 80 - |
*VDC_CTRL_FORE :                 20 - | *VDC_CTRL_GRID :                  8 - |
*VDC_CTRL_HINT :                  1 - | *VDC_CTRL_OVRLAY :               10 - |
*VDC_CTRL_SINT :                  4 - | *VDC_GRIDH0 :                   0C0 - |
*VDC_GRIDH1 :                   0C1 - | *VDC_GRIDH2 :                   0C2 - |
*VDC_GRIDH3 :                   0C3 - | *VDC_GRIDH4 :                   0C4 - |
*VDC_GRIDH5 :                   0C5 - | *VDC_GRIDH6 :                   0C6 - |
*VDC_GRIDH7 :                   0C7 - | *VDC_GRIDH8 :                   0C8 - |
*VDC_GRIDI0 :                   0D0 - | *VDC_GRIDI1 :                   0D1 - |
 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 48 - 01/22/2022 23:17:32


*VDC_GRIDI2 :                   0D2 - | *VDC_GRIDI3 :                   0D3 - |
*VDC_GRIDI4 :                   0D4 - | *VDC_GRIDI5 :                   0D5 - |
*VDC_GRIDI6 :                   0D6 - | *VDC_GRIDI7 :                   0D7 - |
*VDC_GRIDI8 :                   0D8 - |  VDC_GRIDV0 :                   0E0 - |
*VDC_GRIDV1 :                   0E1 - | *VDC_GRIDV2 :                   0E2 - |
*VDC_GRIDV3 :                   0E3 - | *VDC_GRIDV4 :                   0E4 - |
*VDC_GRIDV5 :                   0E5 - | *VDC_GRIDV6 :                   0E6 - |
*VDC_GRIDV7 :                   0E7 - | *VDC_GRIDV8 :                   0E8 - |
*VDC_GRIDV9 :                   0E9 - |  VDC_QUAD0 :                     40 - |
 VDC_QUAD1 :                     50 - |  VDC_QUAD2 :                     60 - |
 VDC_QUAD3 :                     70 - | *VDC_SCANLINE :                 0A4 - |
*VDC_SCANROW :                  0A5 - | *VDC_SOUND0 :                   0A7 - |
*VDC_SOUND1 :                   0A8 - | *VDC_SOUND2 :                   0A9 - |
 VDC_SOUNDCTRL :                0AA - | *VDC_SOUND_ENAB :                80 - |
*VDC_SOUND_FREQ :                20 - | *VDC_SOUND_LOOP :                40 - |
*VDC_SOUND_NOISE :               10 - |  VDC_SPR0_CTRL :                  0 - |
 VDC_SPR0_SHAPE :                80 - | *VDC_SPR1_CTRL :                  4 - |
*VDC_SPR1_SHAPE :                88 - | *VDC_SPR2_CTRL :                  8 - |
*VDC_SPR2_SHAPE :                90 - | *VDC_SPR3_CTRL :                 0C - |
*VDC_SPR3_SHAPE :                98 - | *VDC_STATUS :                   0A1 - |
*VDC_STAT_BIT4 :                 10 - | *VDC_STAT_BIT5 :                 20 - |
*VDC_STAT_CHRLAP :               80 - | *VDC_STAT_HBLANK :                1 - |
*VDC_STAT_OVRLAY :               40 - | *VDC_STAT_PSTRB :                 2 - |
*VDC_STAT_SOUND :                 4 - | *VDC_STAT_VBLANK :                8 - |
*VERSION :                     142F - | *VPP_BUSY :                       6 - |
*VPP_TA_CMD :                     2 - | *VPP_TA_RD :                      4 - |
*VPP_TA_WR :                      0 - | *VPP_TB_CMD :                     3 - |
*VPP_TB_RD :                      5 - | *VPP_TB_WR :                      1 - |
 VSYNCIRQ :                      1A - | *WAITFORKEY :                   13D - |
*WAITVSYNC :                    176 - | *WRITE_EXTRAM_CHAR_BYTES :      418 C |
*WRITE_EXTRAM_CHAR_BYTES.ALSO_CHECK_IF_NOT_ZERO :                       42B C |
 WRITE_EXTRAM_CHAR_BYTES.WRITE_TO_EXTERNAL_RAM :                        41E C |
*Z80SYNTAX :                      0 - |  __BACK3 :                      819 C |
 __BACK4 :                     0A30 C |  __BACK5 :                     0A85 C |
 __FORW0 :                      898 C |  __FORW1 :                      920 C |
 __FORW10 :                    0A35 C | *__FORW11 :                    0AB2 C |
 __FORW12 :                    0AD8 C |  __FORW13 :                    0B2D C |
 __FORW14 :                    0B37 C |  __FORW2 :                      934 C |
 __FORW3 :                      948 C |  __FORW4 :                      95C C |
 __FORW5 :                      9A8 C |  __FORW6 :                      9B6 C |
 __FORW7 :                      9C4 C |  __FORW8 :                      9D2 C |
 __FORW9 :                     0A1D C |

    423 symbols
    285 unused symbols

 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 49 - 01/22/2022 23:17:32


  Defined Macros:
  ---------------

ASSERT                                | COMPUTE_CHAR_MACRO                   
DISABLE_VDC_FOREGROUND                | ENABLE_VDC_FOREGROUND                
INLINE_EXTERNAL_RAM                   | INLINE_EXTERNAL_VDC                  
READ_EXTRAM_CHAR                      | SLEEP_LOOP                           
SLEEP_NOP                             | WRITE_EXTRAM_CHAR                    
WRITE_EXTRAM_STRING                   | WRITE_TO_CHAR                        

     12 macros

 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 50 - 01/22/2022 23:17:32


  Defined Functions:
  ------------------

CALC_EXTRAM_CHAR                      | CALC_CHAR_3                          
CALC_CHAR_2                           | ROTRN                                
ROTLN                                 | SHRN                                 
SHLN                                  | GETBIT                               
EVEN                                  | ODD                                  
LOWORD                                | HIWORD                               
LO                                    | HI                                   
CUTOUT                                | INVMASK                              
MASK                                  |

 AS V1.42 Beta [Bld 213] - Source File main.asm - Page 51 - 01/22/2022 23:17:32


  Code Pages:
  ----------

STANDARD (0 changed characters)
VIDEOPAC (47 changed characters)

2 code pages

0.06 seconds assembly time

   2049 lines source file
   2658 lines incl. macro expansions
      3 passes
      0 errors
      0 warnings
